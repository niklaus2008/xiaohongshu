/**
 * æµ‹è¯•è¯„è¯­æ ¼å¼ä¿®å¤æ•ˆæœ
 * éªŒè¯ç”Ÿæˆçš„è¯„è¯­ä¸å†åŒ…å«"æ ‡é¢˜:"ã€"æ­£æ–‡:"ã€"ç»“å°¾æ ‡ç­¾:"ç­‰æ ¼å¼æ ‡è¯†è¯
 */

const GLMClient = require('../src/glm-client');

async function testReviewFormatFix() {
    console.log('ğŸ§ª å¼€å§‹æµ‹è¯•è¯„è¯­æ ¼å¼ä¿®å¤æ•ˆæœ...\n');

    // åˆ›å»ºGLMå®¢æˆ·ç«¯
    const glmClient = new GLMClient({
        apiKey: process.env.GLM_API_KEY || '3134eeac071543cda4d2a9f7a82a38af.Uz7CREy8nd3HVMC2',
        model: 'glm-4-flash'
    });

    // æ¨¡æ‹Ÿå›¾ç‰‡åˆ†æç»“æœ
    const mockAnalysisResults = [
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ å®«ä¿é¸¡ä¸çš„å›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°é¸¡è‚‰å—ã€èŠ±ç”Ÿç±³ã€è¾£æ¤’ç­‰é£Ÿæï¼Œè‰²æ³½çº¢äº®ï¼Œçœ‹èµ·æ¥å¾ˆæœ‰é£Ÿæ¬²ã€‚',
            imagePath: '/test/å®«ä¿é¸¡ä¸.jpg'
        },
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ éº»å©†è±†è…çš„å›¾ç‰‡ï¼Œè±†è…å«©æ»‘ï¼Œçº¢æ²¹æ±¤åº•æµ“éƒï¼Œé…èœä¸°å¯Œï¼Œçœ‹èµ·æ¥éº»è¾£é²œé¦™ã€‚',
            imagePath: '/test/éº»å©†è±†è….jpg'
        },
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ æ°´ç…®é±¼çš„å›¾ç‰‡ï¼Œé±¼ç‰‡å«©æ»‘ï¼Œé…èœæœ‰è±†èŠ½ã€åœŸè±†ç‰‡ç­‰ï¼Œçº¢æ²¹æ±¤åº•çœ‹èµ·æ¥å¾ˆè¯±äººã€‚',
            imagePath: '/test/æ°´ç…®é±¼.jpg'
        }
    ];

    // æ›´æ–°åçš„è¯„è¯­ç”Ÿæˆæç¤ºè¯ï¼ˆä¸åŒ…å«æ ¼å¼æ ‡è¯†è¯ï¼‰
    const reviewPrompt = `# è§’è‰²
ä½ æ˜¯ä¸€ä½æ™®é€šçš„ç¾é£Ÿçˆ±å¥½è€…ï¼Œä¸æ˜¯ä¸“ä¸šçš„åšä¸»ã€‚ä½ å†™è¯„ä»·çš„ç›®çš„æ˜¯ä¸ºäº†å®¢è§‚è®°å½•è‡ªå·±çš„ç”¨é¤æ„Ÿå—ï¼Œå¹¶ç»™å…¶ä»–é£Ÿå®¢æä¾›çœŸå®çš„å‚è€ƒã€‚ä½ çš„è¯­è¨€é£æ ¼æœ´å®ã€çœŸè¯šï¼Œä¼šæ³¨é‡æè¿°äº‹å®å’Œç»†èŠ‚ï¼Œè€Œä¸æ˜¯å †ç Œå½¢å®¹è¯ã€‚

# ä»»åŠ¡
æ ¹æ®ç”¨æˆ·æä¾›çš„åº—å®¶ä¿¡æ¯ï¼Œåˆ›ä½œä¸€ç¯‡çº¦300å­—çš„ã€é£æ ¼çœŸå®çš„äº”æ˜Ÿå¥½è¯„ç¬”è®°ã€‚è¯„ä»·åº”å¬èµ·æ¥åƒä¸€ä¸ªç»†å¿ƒçš„æ™®é€šé¡¾å®¢å†™çš„ï¼Œå¯ä»¥æœ‰è¤’å¥–ï¼Œä½†è¦è¯´å‡ºå…·ä½“å¥½åœ¨å“ªé‡Œã€‚

# é£æ ¼ä¸è¦æ±‚
1.  **è¯­æ°”è‡ªç„¶ï¼Œé¿å…å¤¸å¼ **:
    * **æ ¸å¿ƒè¦æ±‚**ï¼šå®Œå…¨é¿å…ä½¿ç”¨"YYDS"ã€"ç»ç»å­"ã€"å¥½åƒåˆ°å“­"è¿™ç±»è¿‡äºå¤¸å¼ çš„ç½‘ç»œçƒ­è¯ã€‚
    * è¯·ä½¿ç”¨æ›´ç”Ÿæ´»åŒ–çš„æ­£é¢è¯æ±‡ï¼Œä¾‹å¦‚ï¼š"å‘³é“ä¸é”™"ã€"å°è±¡æŒºæ·±"ã€"ç¡®å®å¯ä»¥"ã€"å€¼å¾—ä¸€è¯•"ã€"æ²¡æœ‰è¸©é›·"ã€"æ¯”é¢„æƒ³çš„å¥½"ã€‚

2.  **æè¿°å…·ä½“ï¼Œå°‘ç”¨å½¢å®¹è¯**:
    * ä¸è¦åªè¯´"å¥½åƒ"ï¼Œè¦è¯´å‡º"æ€ä¹ˆä¸ªå¥½åƒæ³•"ã€‚
    * **é¼“åŠ±çš„æè¿°æ–¹å¼**ï¼šå¤šæè¿°å£æ„Ÿã€é£Ÿæå’Œåšæ³•å¸¦æ¥çš„æ„Ÿå—ã€‚ä¾‹å¦‚ï¼Œç”¨"é±¼è‚‰å¾ˆå«©ï¼Œç­·å­ä¸€å¤¹å°±ä¸‹æ¥äº†ï¼Œè€Œä¸”æ²¡ä»€ä¹ˆåˆº"æ¥ä»£æ›¿"é±¼è‚‰å…¥å£å³åŒ–"ï¼›ç”¨"é…±æ±æ˜¯å’¸ç”œå£çš„ï¼Œå¾ˆä¸‹é¥­"æ¥ä»£æ›¿"é…±æ±æµ“éƒç¾å‘³"ã€‚

3.  **å†…å®¹æœ‰ä¾§é‡ï¼Œè€Œéå…¨éƒ¨å¹æ§**:
    * å¯ä»¥é‡ç‚¹å¤¸ä¸€ä¸¤é“æœ€å‡ºå½©çš„èœï¼Œå…¶ä»–èœå“å¯ä»¥ç”¨"ä¹Ÿè¿˜ä¸é”™"ã€"ä¸­è§„ä¸­çŸ©"ç­‰è¯è¯­å¸¦è¿‡ï¼Œè¿™æ ·æ›´æ˜¾çœŸå®ã€‚
    * å¯ä»¥åœ¨å¤¸èµèœå“çš„åŒæ—¶ï¼ŒæåŠä¸€äº›ä¸­æ€§çš„ç»†èŠ‚ï¼Œå¦‚"åº—é‡ŒäººæŒºå¤šçš„ï¼Œé¥­ç‚¹å¯èƒ½è¦ç­‰ä½"ã€"ä»·æ ¼ä¸ç®—ä¾¿å®œï¼Œä½†ç”¨æ–™ç¡®å®ä¸é”™"ç­‰ï¼Œè®©è¯„ä»·æ›´ç«‹ä½“ã€‚

4.  **è¾“å‡ºæ ¼å¼è¦æ±‚**:
    * **é‡è¦**ï¼šç›´æ¥è¾“å‡ºè¯„è¯­å†…å®¹ï¼Œä¸è¦åŒ…å«"æ ‡é¢˜:"ã€"æ­£æ–‡:"ã€"ç»“å°¾æ ‡ç­¾:"ç­‰æ ¼å¼æ ‡è¯†è¯ã€‚
    * **æ ‡é¢˜**: ç®€å•ç›´æ¥ï¼Œå¯ä»¥åŠ ä¸ŠEmojiï¼Œä½†ä¸è¦è¿‡äºæµ®å¤¸ã€‚
    * **æ­£æ–‡**: å…ˆè¯´æ•´ä½“æ„Ÿå—ï¼Œå†åˆ†ç‚¹è¯´å‡ é“èœï¼Œæœ€åç®€å•æ€»ç»“ã€‚
    * **ç»“å°¾æ ‡ç­¾**: å¿…é¡»åŒ…å«ä»¥ä¸‹æ´»åŠ¨æ ‡ç­¾ï¼š#åˆ›ä½œè€…èµé‡‘è®¡åˆ’ #0å…ƒç©è½¬è¿™åº§åŸ #åŸå¸‚å‘å¯¼å®˜# ä¼˜è´¨åˆ›ä½œè€…èµé‡‘è®¡åˆ’ï¼Œç„¶ååŠ ä¸Šåº—å®¶å…³é”®è¯ã€‚

5.  **é¿å…é‡å¤è¯­å¥**:
    * **ä¸¥æ ¼ç¦æ­¢**ä½¿ç”¨ä»¥ä¸‹å›ºå®šè¯­å¥ï¼š"åº—é‡ŒäººæŒºå¤šçš„ï¼Œé¥­ç‚¹å¯èƒ½è¦ç­‰ä½ï¼Œä»·æ ¼ä¸ç®—ä¾¿å®œï¼Œä½†ç”¨æ–™ç¡®å®ä¸é”™"ã€‚
    * æ¯æ¬¡ç”Ÿæˆè¯„è¯­æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å®Œå…¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼å’Œè¯æ±‡ã€‚
    * å¯ä»¥å˜åŒ–çš„ä¸­æ€§æè¿°ï¼šå¦‚"ç¯å¢ƒä¸é”™"ã€"æœåŠ¡æ€åº¦å¥½"ã€"æ€§ä»·æ¯”è¿˜å¯ä»¥"ã€"å€¼å¾—æ¨è"ã€"ä½ç½®æ–¹ä¾¿"ã€"è£…ä¿®æœ‰ç‰¹è‰²"ã€"æœåŠ¡å‘¨åˆ°"ç­‰ã€‚
    * å¦‚æœå¿…é¡»æåŠç±»ä¼¼å†…å®¹ï¼Œè¯·ç”¨å®Œå…¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼ï¼Œå¦‚"äººæ°”å¾ˆæ—º"ã€"ç¯å¢ƒèˆ’é€‚"ã€"ä»·æ ¼åˆç†"ã€"é£Ÿææ–°é²œ"ç­‰ã€‚

6.  **ç»“åˆç‰¹è‰²èœä¿¡æ¯**:
    * å¦‚æœæä¾›äº†åº—å®¶çš„ç‰¹è‰²èœä¿¡æ¯ï¼Œè¦ç»“åˆå›¾ç‰‡åˆ†æç»“æœï¼Œé‡ç‚¹æè¿°è¿™äº›ç‰¹è‰²èœã€‚
    * å°†ç½‘ä¸ŠæŸ¥åˆ°çš„ç‰¹è‰²èœä¸å›¾ç‰‡ä¸­çœ‹åˆ°çš„èœå“ç›¸ç»“åˆï¼Œå†™å‡ºæ›´çœŸå®çš„è¯„ä»·ã€‚

# è¾“å‡ºè¦æ±‚
è¯·ç›´æ¥è¾“å‡ºè¯„è¯­å†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

[æ ‡é¢˜å†…å®¹]

[æ­£æ–‡å†…å®¹]

[ç»“å°¾æ ‡ç­¾å†…å®¹]

ä¸è¦åŒ…å«"æ ‡é¢˜:"ã€"æ­£æ–‡:"ã€"ç»“å°¾æ ‡ç­¾:"ç­‰æ ‡è¯†è¯ï¼Œç›´æ¥è¾“å‡ºçº¯å‡€çš„è¯„è¯­å†…å®¹ã€‚`;

    try {
        console.log('ğŸ¤– å¼€å§‹ç”Ÿæˆè¯„è¯­...');
        
        const result = await glmClient.generateRestaurantReview(
            mockAnalysisResults,
            'å·å‘³è½©',
            'åŒ—äº¬æœé˜³åŒº',
            reviewPrompt
        );

        if (result.success) {
            console.log('âœ… è¯„è¯­ç”ŸæˆæˆåŠŸï¼\n');
            console.log('ğŸ“ ç”Ÿæˆçš„è¯„è¯­å†…å®¹ï¼š');
            console.log('=' * 50);
            console.log(result.review);
            console.log('=' * 50);
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ ¼å¼æ ‡è¯†è¯
            const formatKeywords = ['æ ‡é¢˜:', 'æ­£æ–‡:', 'ç»“å°¾æ ‡ç­¾:'];
            const containsFormatKeywords = formatKeywords.some(keyword => 
                result.review.includes(keyword)
            );
            
            if (containsFormatKeywords) {
                console.log('\nâŒ å‘ç°é—®é¢˜ï¼šç”Ÿæˆçš„è¯„è¯­ä»ç„¶åŒ…å«æ ¼å¼æ ‡è¯†è¯');
                formatKeywords.forEach(keyword => {
                    if (result.review.includes(keyword)) {
                        console.log(`   - åŒ…å« "${keyword}"`);
                    }
                });
            } else {
                console.log('\nâœ… æ ¼å¼æ£€æŸ¥é€šè¿‡ï¼šç”Ÿæˆçš„è¯„è¯­ä¸åŒ…å«æ ¼å¼æ ‡è¯†è¯');
                console.log('âœ… è¯„è¯­æ ¼å¼ä¿®å¤æˆåŠŸï¼');
            }
            
        } else {
            console.log('âŒ è¯„è¯­ç”Ÿæˆå¤±è´¥:', result.error);
        }

    } catch (error) {
        console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    }
}

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
    testReviewFormatFix().catch(console.error);
}

module.exports = testReviewFormatFix;
