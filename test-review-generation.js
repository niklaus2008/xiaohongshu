/**
 * è¯„è¯­ç”ŸæˆåŠŸèƒ½æµ‹è¯•è„šæœ¬
 * æµ‹è¯•GLM-4.5-Flashç”Ÿæˆé¤é¦†è¯„è¯­çš„åŠŸèƒ½
 */

const GLMClient = require('./src/glm-client');
const fs = require('fs-extra');
const path = require('path');

async function testReviewGeneration() {
    console.log('ğŸ“ å¼€å§‹æµ‹è¯•è¯„è¯­ç”ŸæˆåŠŸèƒ½...\n');

    // åˆ›å»ºGLMå®¢æˆ·ç«¯
    const glmClient = new GLMClient({
        apiKey: '3134eeac071543cda4d2a9f7a82a38af.Uz7CREy8nd3HVMC2',
        model: 'glm-4-flash'
    });

    // æ¨¡æ‹Ÿå›¾ç‰‡åˆ†æç»“æœ
    const mockAnalysisResults = [
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ ç²¾ç¾çš„å·èœå›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°çº¢æ²¹æ»¡æ»¡çš„å®«ä¿é¸¡ä¸ï¼Œé¸¡è‚‰å«©æ»‘ï¼ŒèŠ±ç”Ÿç±³é…¥è„†ï¼Œé…èœä¸°å¯Œï¼Œè‰²æ³½è¯±äººã€‚æ•´ä½“æ‘†ç›˜ç²¾è‡´ï¼Œä½“ç°äº†å·èœçš„éº»è¾£ç‰¹è‰²ã€‚',
            imagePath: '/test/å·èœ1.jpg'
        },
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ é¤å…ç¯å¢ƒå›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°å¤è‰²å¤é¦™çš„è£…ä¿®é£æ ¼ï¼Œæœ¨è´¨æ¡Œæ¤…ï¼Œæš–é»„è‰²ç¯å…‰ï¼Œè¥é€ å‡ºæ¸©é¦¨çš„ç”¨é¤æ°›å›´ã€‚å¢™ä¸ŠæŒ‚ç€ä¼ ç»Ÿå­—ç”»ï¼Œä½“ç°äº†ä¸­å¼é¤å…çš„æ–‡åŒ–åº•è•´ã€‚',
            imagePath: '/test/ç¯å¢ƒ1.jpg'
        },
        {
            success: true,
            analysis: 'è¿™æ˜¯ä¸€å¼ æ‹›ç‰Œèœå›¾ç‰‡ï¼Œå¯ä»¥çœ‹åˆ°éº»è¾£é¦™é”…ï¼Œé£Ÿæä¸°å¯Œå¤šæ ·ï¼ŒåŒ…æ‹¬åœŸè±†ã€è—•ç‰‡ã€è±†çš®ã€è‚‰ç‰‡ç­‰ï¼Œçº¢æ²¹æ±¤åº•æµ“éƒï¼Œé…èœæ–°é²œï¼Œçœ‹èµ·æ¥å¾ˆæœ‰é£Ÿæ¬²ã€‚',
            imagePath: '/test/æ‹›ç‰Œèœ1.jpg'
        }
    ];

    // è¯„è¯­ç”Ÿæˆæç¤ºè¯
    const reviewPrompt = `# è§’è‰²
ä½ æ˜¯ä¸€ä½æ™®é€šçš„ç¾é£Ÿçˆ±å¥½è€…ï¼Œä¸æ˜¯ä¸“ä¸šçš„åšä¸»ã€‚ä½ å†™è¯„ä»·çš„ç›®çš„æ˜¯ä¸ºäº†å®¢è§‚è®°å½•è‡ªå·±çš„ç”¨é¤æ„Ÿå—ï¼Œå¹¶ç»™å…¶ä»–é£Ÿå®¢æä¾›çœŸå®çš„å‚è€ƒã€‚ä½ çš„è¯­è¨€é£æ ¼æœ´å®ã€çœŸè¯šï¼Œä¼šæ³¨é‡æè¿°äº‹å®å’Œç»†èŠ‚ï¼Œè€Œä¸æ˜¯å †ç Œå½¢å®¹è¯ã€‚

# ä»»åŠ¡
æ ¹æ®ç”¨æˆ·æä¾›çš„åº—å®¶ä¿¡æ¯ï¼Œåˆ›ä½œä¸€ç¯‡çº¦300å­—çš„ã€é£æ ¼çœŸå®çš„äº”æ˜Ÿå¥½è¯„ç¬”è®°ã€‚è¯„ä»·åº”å¬èµ·æ¥åƒä¸€ä¸ªç»†å¿ƒçš„æ™®é€šé¡¾å®¢å†™çš„ï¼Œå¯ä»¥æœ‰è¤’å¥–ï¼Œä½†è¦è¯´å‡ºå…·ä½“å¥½åœ¨å“ªé‡Œã€‚

# é£æ ¼ä¸è¦æ±‚
1.  **è¯­æ°”è‡ªç„¶ï¼Œé¿å…å¤¸å¼ **:
    * **æ ¸å¿ƒè¦æ±‚**ï¼šå®Œå…¨é¿å…ä½¿ç”¨"YYDS"ã€"ç»ç»å­"ã€"å¥½åƒåˆ°å“­"è¿™ç±»è¿‡äºå¤¸å¼ çš„ç½‘ç»œçƒ­è¯ã€‚
    * è¯·ä½¿ç”¨æ›´ç”Ÿæ´»åŒ–çš„æ­£é¢è¯æ±‡ï¼Œä¾‹å¦‚ï¼š"å‘³é“ä¸é”™"ã€"å°è±¡æŒºæ·±"ã€"ç¡®å®å¯ä»¥"ã€"å€¼å¾—ä¸€è¯•"ã€"æ²¡æœ‰è¸©é›·"ã€"æ¯”é¢„æƒ³çš„å¥½"ã€‚

2.  **æè¿°å…·ä½“ï¼Œå°‘ç”¨å½¢å®¹è¯**:
    * ä¸è¦åªè¯´"å¥½åƒ"ï¼Œè¦è¯´å‡º"æ€ä¹ˆä¸ªå¥½åƒæ³•"ã€‚
    * **é¼“åŠ±çš„æè¿°æ–¹å¼**ï¼šå¤šæè¿°å£æ„Ÿã€é£Ÿæå’Œåšæ³•å¸¦æ¥çš„æ„Ÿå—ã€‚ä¾‹å¦‚ï¼Œç”¨"é±¼è‚‰å¾ˆå«©ï¼Œç­·å­ä¸€å¤¹å°±ä¸‹æ¥äº†ï¼Œè€Œä¸”æ²¡ä»€ä¹ˆåˆº"æ¥ä»£æ›¿"é±¼è‚‰å…¥å£å³åŒ–"ï¼›ç”¨"é…±æ±æ˜¯å’¸ç”œå£çš„ï¼Œå¾ˆä¸‹é¥­"æ¥ä»£æ›¿"é…±æ±æµ“éƒç¾å‘³"ã€‚

3.  **å†…å®¹æœ‰ä¾§é‡ï¼Œè€Œéå…¨éƒ¨å¹æ§**:
    * å¯ä»¥é‡ç‚¹å¤¸ä¸€ä¸¤é“æœ€å‡ºå½©çš„èœï¼Œå…¶ä»–èœå“å¯ä»¥ç”¨"ä¹Ÿè¿˜ä¸é”™"ã€"ä¸­è§„ä¸­çŸ©"ç­‰è¯è¯­å¸¦è¿‡ï¼Œè¿™æ ·æ›´æ˜¾çœŸå®ã€‚
    * å¯ä»¥åœ¨å¤¸èµèœå“çš„åŒæ—¶ï¼ŒæåŠä¸€äº›ä¸­æ€§çš„ç»†èŠ‚ï¼Œå¦‚"åº—é‡ŒäººæŒºå¤šçš„ï¼Œé¥­ç‚¹å¯èƒ½è¦ç­‰ä½"ã€"ä»·æ ¼ä¸ç®—ä¾¿å®œï¼Œä½†ç”¨æ–™ç¡®å®ä¸é”™"ç­‰ï¼Œè®©è¯„ä»·æ›´ç«‹ä½“ã€‚

4.  **ç»“æ„ä¸æ ¼å¼**: ä¾ç„¶ä¿ç•™å¤§ä¼—ç‚¹è¯„çš„æ ¼å¼è¦æ±‚ã€‚
    * **æ ‡é¢˜**: ç®€å•ç›´æ¥ï¼Œå¯ä»¥åŠ ä¸ŠEmojiï¼Œä½†ä¸è¦è¿‡äºæµ®å¤¸ã€‚
    * **æ­£æ–‡**: å…ˆè¯´æ•´ä½“æ„Ÿå—ï¼Œå†åˆ†ç‚¹è¯´å‡ é“èœï¼Œæœ€åç®€å•æ€»ç»“ã€‚
    * **ç»“å°¾æ ‡ç­¾**: å¿…é¡»åŒ…å«ä»¥ä¸‹æ´»åŠ¨æ ‡ç­¾ï¼š#åˆ›ä½œè€…èµé‡‘è®¡åˆ’ #0å…ƒç©è½¬è¿™åº§åŸ #åŸå¸‚å‘å¯¼å®˜# ä¼˜è´¨åˆ›ä½œè€…èµé‡‘è®¡åˆ’ï¼Œç„¶ååŠ ä¸Šåº—å®¶å…³é”®è¯ã€‚

5.  **é¿å…é‡å¤è¯­å¥**:
    * **ä¸¥æ ¼ç¦æ­¢**ä½¿ç”¨ä»¥ä¸‹å›ºå®šè¯­å¥ï¼š"åº—é‡ŒäººæŒºå¤šçš„ï¼Œé¥­ç‚¹å¯èƒ½è¦ç­‰ä½ï¼Œä»·æ ¼ä¸ç®—ä¾¿å®œï¼Œä½†ç”¨æ–™ç¡®å®ä¸é”™"ã€‚
    * æ¯æ¬¡ç”Ÿæˆè¯„è¯­æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å®Œå…¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼å’Œè¯æ±‡ã€‚
    * å¯ä»¥å˜åŒ–çš„ä¸­æ€§æè¿°ï¼šå¦‚"ç¯å¢ƒä¸é”™"ã€"æœåŠ¡æ€åº¦å¥½"ã€"æ€§ä»·æ¯”è¿˜å¯ä»¥"ã€"å€¼å¾—æ¨è"ã€"ä½ç½®æ–¹ä¾¿"ã€"è£…ä¿®æœ‰ç‰¹è‰²"ã€"æœåŠ¡å‘¨åˆ°"ç­‰ã€‚
    * å¦‚æœå¿…é¡»æåŠç±»ä¼¼å†…å®¹ï¼Œè¯·ç”¨å®Œå…¨ä¸åŒçš„è¡¨è¾¾æ–¹å¼ï¼Œå¦‚"äººæ°”å¾ˆæ—º"ã€"ç¯å¢ƒèˆ’é€‚"ã€"ä»·æ ¼åˆç†"ã€"é£Ÿææ–°é²œ"ç­‰ã€‚

6.  **ç»“åˆç‰¹è‰²èœä¿¡æ¯**:
    * å¦‚æœæä¾›äº†åº—å®¶çš„ç‰¹è‰²èœä¿¡æ¯ï¼Œè¦ç»“åˆå›¾ç‰‡åˆ†æç»“æœï¼Œé‡ç‚¹æè¿°è¿™äº›ç‰¹è‰²èœã€‚
    * å°†ç½‘ä¸ŠæŸ¥åˆ°çš„ç‰¹è‰²èœä¸å›¾ç‰‡ä¸­çœ‹åˆ°çš„èœå“ç›¸ç»“åˆï¼Œå†™å‡ºæ›´çœŸå®çš„è¯„ä»·ã€‚

è¯·æ ¹æ®æä¾›çš„é¤é¦†å›¾ç‰‡åˆ†æç»“æœï¼Œç”Ÿæˆä¸€ç¯‡çœŸå®çš„äº”æ˜Ÿå¥½è¯„ç¬”è®°ã€‚`;

    try {
        console.log('ğŸ¤– å¼€å§‹ç”Ÿæˆè¯„è¯­...');
        
        const result = await glmClient.generateRestaurantReview(
            mockAnalysisResults,
            'å·å‘³è½©',
            'åŒ—äº¬æœé˜³åŒº',
            reviewPrompt
        );

        if (result.success) {
            console.log('âœ… è¯„è¯­ç”ŸæˆæˆåŠŸï¼');
            console.log('\nğŸ“ ç”Ÿæˆçš„è¯„è¯­ï¼š');
            console.log('=' * 50);
            console.log(result.review);
            console.log('=' * 50);
            
            // ä¿å­˜è¯„è¯­åˆ°æ–‡ä»¶
            const reviewPath = './test-review.md';
            await fs.writeFile(reviewPath, result.review, 'utf8');
            console.log(`\nğŸ’¾ è¯„è¯­å·²ä¿å­˜åˆ°: ${reviewPath}`);
            
        } else {
            console.log(`âŒ è¯„è¯­ç”Ÿæˆå¤±è´¥: ${result.error}`);
        }

    } catch (error) {
        console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    }

    console.log('\nğŸ‰ è¯„è¯­ç”ŸæˆåŠŸèƒ½æµ‹è¯•å®Œæˆï¼');
}

// è¿è¡Œæµ‹è¯•
if (require.main === module) {
    testReviewGeneration().catch(error => {
        console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
        process.exit(1);
    });
}

module.exports = { testReviewGeneration };
