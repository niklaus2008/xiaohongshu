# 小红书餐馆图片下载工具

## 项目简介

这是一个基于Playwright的自动化工具，可以根据餐馆名称和地点信息，从小红书上搜索并下载对应餐馆的图片。现在支持**Web图形界面**，让您可以通过直观的界面轻松管理批量下载任务。

## 功能特点

### 🖥️ Web图形界面
- **直观易用的Web界面**：无需命令行操作，通过浏览器即可完成所有配置
- **实时进度显示**：可视化进度条和状态信息，清晰了解下载进度
- **批量配置管理**：支持添加、编辑、删除多个餐馆配置
- **配置保存/加载**：自动保存配置，下次使用时无需重新设置
- **实时日志显示**：详细的日志信息，支持按级别过滤
- **详细进度日志**：增加详细的处理进度日志，包括下载图片的实时进度
- **心跳检测**：每30秒发送心跳检测，确保用户了解系统运行状态
- **终端日志转发**：所有终端输出都会实时转发到前端显示，无需查看终端窗口
- **响应式设计**：适配不同屏幕尺寸，支持移动端访问
- **简洁界面**：移除冗余的统计信息，专注于核心功能
- **紧凑进度显示**：优化下载进度界面，使用更紧凑的布局显示餐馆进度

### 🔍 核心功能
- 根据餐馆名称和地点智能搜索
- 自动下载餐馆相关图片
- 支持批量下载
- 自动创建以餐馆名称命名的文件夹管理图片
- 内置反爬虫检测处理
- 详细的日志记录
- 多种登录方式支持（手机号验证码、扫码登录、手动登录）
- Cookie持久化，避免重复登录
- **智能水印去除**：多种策略组合去除小红书水印
- **图片后处理**：使用Sharp库进行图片优化和水印处理
- **🆕 先登录后爬虫**：统一预登录机制，避免重复登录和日志重复问题
- **🔄 共享登录机制**：第一个实例完成登录，其他实例使用共享Cookie，避免重复登录
- **🆕 统一图片数配置**：所有餐馆统一使用配置管理中的图片数设置，简化配置流程

## 🆕 先登录后爬虫功能

### 功能说明
为了解决批量下载时每个餐馆都重复登录的问题，我们实现了"先登录后爬虫"的机制：

1. **统一预登录**：在批量处理开始前，先完成一次统一的登录
2. **共享登录状态**：所有爬虫实例共享同一个登录状态，避免重复登录
3. **减少日志重复**：登录只发生一次，大大减少重复日志
4. **提高效率**：不需要每个实例都重新登录
5. **前端进度显示**：实时显示预登录进度，用户体验更好

## 🔄 共享登录机制

### 功能说明
为了进一步优化登录流程，我们实现了更智能的共享登录机制：

1. **第一个实例负责登录**：只有第一个爬虫实例会执行完整的登录流程
2. **其他实例使用共享Cookie**：后续实例直接使用第一个实例获取的Cookie
3. **独立页面避免冲突**：每个实例创建独立的页面，避免状态冲突
4. **避免重复登录窗口**：只有一个登录窗口出现，其他实例等待共享状态
5. **串行处理优化**：改为串行处理，确保一个窗口完成登录后再弹出其他实例

### 实现原理
- **预登录阶段**：第一个实例完成登录，获取Cookie和登录状态
- **共享状态**：将浏览器实例、Cookie等信息保存到共享状态
- **串行处理**：任务按顺序处理，第一个实例完成登录后，第二个实例才开始
- **避免冲突**：每个实例使用独立页面，但共享登录状态

### 🆕 串行处理优化
- **maxConcurrent设置为1**：确保同时只有一个任务在处理
- **串行任务队列**：任务按顺序一个接一个处理，避免并发冲突
- **登录状态共享**：第一个实例完成登录后，后续实例直接使用共享的登录状态
- **避免重复登录**：每个实例都会检查并使用共享登录状态，避免重复登录

### 🆕 单实例爬虫模式
- **全局爬虫实例**：整个批量处理过程只创建一个爬虫实例，所有餐馆共享使用
- **状态重置机制**：每次处理新餐馆前自动重置爬虫状态，确保搜索状态独立
- **资源优化**：大幅减少内存使用和浏览器实例创建开销
- **性能提升**：避免重复初始化浏览器，显著提高处理速度
- **智能状态管理**：自动清理页面状态，确保每次搜索都是干净的环境

## 🆕 统一图片数配置功能

### 功能说明
为了简化配置流程，我们实现了统一的图片数配置机制：

1. **全局配置控制**：所有餐馆的图片下载数量统一由"配置管理"中的"每个餐馆下载的图片数"设置控制
2. **移除单独设置**：餐馆条目中不再显示单独的图片数设置，避免配置混乱
3. **CSV导入简化**：导入CSV文件时只需要"餐馆名称,地点"两列，图片数统一使用全局配置
4. **实时显示**：餐馆列表中显示的图片数会实时反映全局配置的数值

### 配置方式
- **全局设置**：在"配置管理"区域设置"每个餐馆下载的图片数"
- **CSV格式**：导入文件格式为"餐馆名称,地点"（图片数由全局配置控制）
- **实时生效**：修改全局配置后，所有餐馆的图片数都会同步更新

### 优势
- **配置简化**：不需要为每个餐馆单独设置图片数
- **统一管理**：所有餐馆使用相同的图片数设置
- **避免混乱**：消除全局配置与单独配置不一致的问题
- **易于维护**：修改图片数只需要调整一个全局设置

## v2.0.21 - 界面美化现代化版本

### 界面设计全面升级
- 🎨 **现代色彩方案**：采用现代蓝色系、紫色系、绿色系、橙色系主题
- ✨ **玻璃拟态效果**：为所有卡片添加毛玻璃背景和模糊效果
- 🌈 **主题化设计**：不同功能区域使用不同的色彩主题
  - 配置设置：蓝色主题 (#3B82F6, #1E40AF)
  - 餐馆配置：紫色主题 (#9333EA, #7C3AED)
  - 配置管理：绿色主题 (#10B981, #059669)
  - 登录状态：橙色主题 (#F59E0B, #D97706)
  - 进度显示：蓝色主题
  - 日志显示：深色主题
- 🎯 **视觉层次优化**：使用渐变背景、阴影效果和动画过渡
- 📱 **响应式设计**：优化移动端显示效果
- ⚡ **动画效果**：添加悬停动画、点击反馈和进度条动画

### 界面布局重新设计
- 🔄 **上下分栏布局**：顶部配置区域 + 下方内容区域
- 📋 **配置功能集中**：所有配置选项集中在界面上半部分
- 🎛️ **操作流程优化**：配置 → 登录 → 开始下载的清晰流程
- 💾 **配置管理突出**：保存/加载配置功能独立成卡片，更加醒目

### 用户体验提升
- 👀 **视觉引导**：通过色彩和布局引导用户操作流程
- 🎨 **美观度大幅提升**：现代化设计语言，符合当前审美趋势
- ⚡ **交互反馈**：按钮悬停、点击动画，提升操作体验
- 📊 **信息层次清晰**：不同功能区域视觉区分明显

## v2.0.20 - 登录框闪退问题彻底修复版本

### 问题描述
用户反馈在"登录状态评分过低，自动重新打开登录页面"后，会短暂出现两次登录框，每个登录框从出现到闪退持续3秒多，到第三次登录框才稳定下来。

### 根本原因分析
经过深入分析，发现问题的根本原因在于：

1. **竞态条件问题**：多个爬虫实例同时检测到登录状态评分过低，导致同时调用`autoReopenLoginPage`方法
2. **等待标志设置时机错误**：在`autoReopenLoginPage`方法中，如果登录窗口未打开，会直接返回成功，没有设置等待标志
3. **全局状态管理不完善**：全局登录管理器的检查逻辑可能被绕过，多个实例可能同时通过检查
4. **状态检查逻辑缺陷**：在等待期间仍然会调用登录状态检测，导致登录框闪烁

### 修复方案
1. **修复等待标志设置时机**：在`autoReopenLoginPage`方法中，无论登录窗口是否打开，都设置等待标志
2. **增强全局状态检查**：在`checkLoginStatus`和`getUnifiedLoginStatus`方法中添加更严格的全局状态检查
3. **优化全局登录管理器**：增加更严格的互斥控制，防止多个实例同时处理登录
4. **完善竞态条件防护**：添加五重检查机制，确保只有一个实例能够处理登录

### 修复内容
- **修复`autoReopenLoginPage`方法**：在登录窗口未打开时，设置等待标志并等待30秒，避免重复检测
- **增强`checkLoginStatus`方法**：添加全局状态检查，防止多个实例同时处理登录
- **优化`getUnifiedLoginStatus`方法**：在等待期间和全局状态检查期间跳过页面登录状态检查
- **改进全局登录管理器**：增加更严格的互斥控制，添加五重检查机制
- **完善竞态条件防护**：确保只有一个实例能够开始登录处理
- **修复`waitForQrCodeLogin`方法**：在等待期间完全停止所有登录状态检测，避免登录框闪烁
- **修复`detectCrossWindowLoginChange`方法**：在等待期间跳过登录状态检测
- **修复`searchAndDownload`方法**：在等待期间跳过登录状态检测
- **修复`waitForLogin`方法**：在等待期间完全停止所有登录状态检测
- **修复所有跨窗口登录状态检测**：在等待期间完全停止所有跨窗口登录状态检测
- **修复所有重新检查登录状态的地方**：在等待期间完全停止所有重新检查登录状态
- **修复所有统一登录状态检测的地方**：在等待期间完全停止所有统一登录状态检测
- **修复所有检测跨窗口登录状态变化的地方**：在等待期间完全停止所有检测跨窗口登录状态变化
- **修复searchAndDownload方法中的等待期间检查逻辑**：确保登录完成后能够正常执行搜索和下载
- **增强网络错误处理和重试机制**：添加智能重试策略，处理ERR_ABORTED等网络错误
- **更新搜索栏选择器**：支持更多页面结构变化，提高搜索栏识别成功率
- **添加智能错误分类和重试策略**：根据错误类型采用不同的重试策略
- **修复弹窗遮罩拦截点击问题**：自动检测和关闭弹窗遮罩，避免点击被拦截
- **添加验证码检测和处理机制**：智能检测验证码，等待用户处理完成
- **增强搜索栏点击稳定性**：使用强制点击和多种点击策略
- **修复多实例并发下载时文件名冲突问题**：添加实例ID到文件名中，确保文件唯一性
- **修复共享页面实例导致搜索状态冲突问题**：为每个爬虫实例创建独立页面，避免搜索结果混乱
- **在等待期间完全停止所有登录状态检测**：避免登录框闪烁
- **添加测试脚本**：提供`test-login-fix.js`验证修复效果

### 技术实现
- **等待标志设置**：在`autoReopenLoginPage`方法中正确设置`_isWaitingForLogin`标志
- **全局状态检查**：在登录状态检测前检查全局状态，防止重复处理
- **互斥控制**：使用同步锁和五重检查机制确保只有一个实例处理登录
- **状态清理**：正确清理等待标志和全局状态，避免状态不一致

### 修复效果
- ✅ 只会出现一个登录框，不会出现闪退问题
- ✅ 多个实例不会同时处理登录
- ✅ 等待期间不会触发重复的登录检测
- ✅ 全局状态管理更加严格和可靠
- ✅ 竞态条件得到有效控制

## v2.0.18 - 登录框闪烁问题彻底修复版本

### 问题描述
用户反馈在扫码登录后，登录框会出现频繁闪烁的问题：
- 扫码后登录框消失
- 立即又出现登录框
- 刚扫上又消失，循环往复
- 无法正常完成登录

### 问题根源分析
经过深入分析，发现问题的真正根源：

1. **`_lastLoginAttempt` 没有被正确设置**：修复逻辑依赖于 `this._lastLoginAttempt`，但这个值只在 `autoReopenLoginPage` 方法中被设置，而用户扫码登录成功时，这个方法根本没有被调用！

2. **修复逻辑位置错误**：修复逻辑在错误的位置，应该在用户登录成功时立即设置时间戳

3. **时序问题**：用户扫码登录成功后，系统立即进行登录状态检测，但此时 `_lastLoginAttempt` 还是 `undefined`，导致修复逻辑失效

### 修复内容

#### 1. 在用户登录成功时设置时间戳
```javascript
// 用户登录成功后立即设置时间戳
if (loginDetected) {
    console.log('✅ 用户已完成登录（提前检测到）');
    this._lastLoginAttempt = Date.now(); // 关键修复！
    console.log('🕐 已设置登录尝试时间，防止登录框闪烁');
    // ... 其他逻辑
}
```

#### 2. 修复登录状态检测逻辑
- **问题根源**：`_lastLoginAttempt` 没有被正确设置
- **修复方案**：在用户登录成功时立即设置 `_lastLoginAttempt`
- **冷却期延长**：从2分钟增加到5分钟，给用户更多时间完成登录

#### 3. 优化全局登录管理器
- **增加冷却期时间**：从2分钟增加到5分钟
- **防止重复检测**：在冷却期内完全跳过登录状态检测
- **避免实例冲突**：多个实例不会同时触发登录检测

#### 4. 修复后的行为
- **用户扫码登录后**：立即设置 `_lastLoginAttempt` 时间戳
- **后续登录检测**：在5分钟内直接跳过检测，返回登录成功
- **不再出现登录框闪烁**：避免多个实例同时检测登录状态
- **用户体验大幅提升**：可以正常完成扫码登录流程

### 技术细节
```javascript
// 修复前：_lastLoginAttempt 没有被设置
const timeSinceLastLogin = this._lastLoginAttempt ? Date.now() - this._lastLoginAttempt : Infinity;
// timeSinceLastLogin 永远是 Infinity，修复逻辑永远不会触发

// 修复后：在用户登录成功时立即设置时间戳
if (loginDetected) {
    this._lastLoginAttempt = Date.now(); // 关键修复！
    // 后续检测会触发修复逻辑
}

// 修复逻辑：5分钟内直接跳过检测
if (timeSinceLastLogin < 300000) { // 5分钟内
    return {
        loginScore: 10,
        isLoggedIn: true,
        reason: '最近有登录尝试，跳过检测'
    };
}
```

### 使用说明
1. 启动Web界面：`npm run start:web`
2. 配置餐馆信息并开始批量下载
3. 当系统检测到需要登录时，会打开小红书登录页面
4. **扫码登录后，系统会立即设置时间戳，在5分钟内跳过所有登录状态检测**
5. 不再出现登录框闪烁问题，可以正常完成登录流程

### 技术实现
- **BatchProcessor.preLogin()**：预登录阶段，创建专门的登录实例
- **XiaohongshuScraper.useSharedLoginState()**：使用共享登录状态
- **前端预登录进度显示**：实时显示预登录状态和进度
- **智能资源管理**：避免关闭共享的浏览器实例

## 🔧 错误修复与改进

### 用户数据目录持久化修复

#### 问题描述
每次都要扫码登录，Chromium关闭时清除了所有缓存和Cookie。

#### 根本原因
- 浏览器启动时没有设置用户数据目录（--user-data-dir）
- 每次启动都是临时会话，浏览器关闭时所有数据丢失
- 虽然有Cookie文件保存机制，但浏览器本身没有持久化存储

#### 修复方案
1. **添加用户数据目录配置**：在浏览器启动参数中添加 `--user-data-dir` 参数
2. **设置固定数据目录**：使用 `./browser-data` 作为持久化存储目录
3. **确保数据持久化**：浏览器关闭后Cookie、缓存、登录状态都会保留

#### 技术实现
- **xiaohongshu-scraper.js**：使用 `chromium.launchPersistentContext()` 替代 `chromium.launch()`
- **web-interface.js**：同样使用 `launchPersistentContext()` 方法
- **测试脚本**：提供 `test-user-data-dir.js` 验证修复效果
- **API修复**：修复了Playwright API使用错误，正确使用持久化上下文
- **错误处理**：添加了用户数据目录冲突检测和自动清理机制
- **回退机制**：当持久化上下文失败时，自动回退到普通启动模式

### 多个登录窗口问题修复

#### 问题描述
在批量处理多个餐馆时，每个爬虫实例都会检测到登录状态评分过低，导致同时弹出多个登录窗口，用户体验很差。

#### 根本原因
1. **全局登录状态管理器工作不正常**：多个实例几乎同时检测到登录状态问题
2. **缺乏真正的互斥锁机制**：没有有效防止多个实例同时处理登录
3. **登录状态检测不一致**：Cookie验证和页面检测结果不一致

#### 修复方案
1. **改进全局状态管理器**：
   - 添加更严格的实例控制机制
   - 增加双重检查防止竞态条件
   - 延长等待时间和检查间隔
   - 添加僵尸实例清理机制

2. **优化登录状态检测逻辑**：
   - 在调用 `autoReopenLoginPage` 前先检查全局状态
   - 添加等待机制，让其他实例等待登录完成
   - 改进状态清理和重置逻辑

3. **添加防护机制**：
   - 僵尸实例自动清理（超过5分钟未完成）
   - 强制重置功能（解决死锁问题）
   - 更详细的日志记录和状态监控

#### 技术实现
- **global-login-manager.js**：改进全局状态管理逻辑，添加僵尸实例清理
- **xiaohongshu-scraper.js**：在登录状态检测前添加全局状态检查
- **测试脚本**：提供 `test-multiple-login-fix.js` 验证修复效果
- **防护机制**：添加多重防护，确保只有一个实例处理登录

#### 进一步改进
1. **增强竞态条件防护**：
   - 添加三重检查机制，防止高并发情况下的竞态条件
   - 实现原子性操作，确保状态设置的一致性
   - 添加状态回滚机制，防止部分设置失败

2. **智能等待机制**：
   - 根据全局状态动态调整等待时间
   - 如果正在重新打开登录页面，等待更长时间（15秒）
   - 否则等待标准时间（5秒）

3. **登录状态一致性检查**：
   - 添加 `checkLoginConsistency()` 方法
   - 当Cookie验证和页面检测不一致时，进行深度验证
   - 通过访问个人页面来确认真实登录状态
   - 提供详细的一致性检查日志

4. **测试验证**：
   - 提供 `test-login-consistency.js` 全面测试脚本
   - 测试互斥机制、状态清理、频繁检查限制
   - 测试僵尸实例清理、强制重置、并发处理

### 重复浏览器窗口问题修复

#### 问题描述
在修复多个登录窗口问题时，出现了新的问题：系统会打开两个浏览器窗口，一个是小红书网站，一个是空白页面。

#### 根本原因
1. **checkLoginConsistency方法中的页面跳转**：访问个人页面时可能触发新窗口创建
2. **重复的浏览器初始化**：多个地方检查 `!this.browser` 并调用 `initBrowser()`
3. **缺乏防重复创建机制**：没有防止同时创建多个浏览器实例的机制

#### 修复方案
1. **改进checkLoginConsistency方法**：
   - 避免访问外部页面，改为检查当前页面元素
   - 如果已在个人页面，直接检查内容
   - 否则在当前页面中查找用户相关元素

2. **添加防重复创建机制**：
   - 添加 `_isInitializing` 标志防止重复初始化
   - 检查现有浏览器实例是否有效
   - 如果浏览器已存在且有效，跳过初始化

3. **优化浏览器实例管理**：
   - 在 `initBrowser()` 方法中添加防重复逻辑
   - 使用 `finally` 块确保标志被正确重置
   - 添加浏览器实例有效性检查

#### 技术实现
- **xiaohongshu-scraper.js**：改进 `checkLoginConsistency()` 和 `initBrowser()` 方法
- **防重复机制**：添加初始化标志和有效性检查
- **测试脚本**：提供 `test-single-browser-window.js` 验证修复效果

### 全局浏览器实例管理修复

#### 问题描述
在批量处理时，虽然修复了防重复创建机制，但仍然出现两个浏览器窗口，原因是每个爬虫实例都尝试创建独立的浏览器实例。

#### 根本原因
1. **共享登录状态失败**：每个实例都尝试访问 `https://www.xiaohongshu.com/explore`，导致网络冲突
2. **缺乏全局实例管理**：没有全局的浏览器实例管理机制
3. **网络访问冲突**：多个实例同时访问同一页面导致 `net::ERR_ABORTED` 错误

#### 修复方案
1. **改进共享登录状态验证**：
   - 检查当前页面是否已经是小红书页面，避免重复跳转
   - 减少超时时间和等待时间，避免网络冲突
   - 添加网络错误处理，假设登录状态有效

2. **添加全局浏览器实例管理**：
   - 使用静态属性管理全局浏览器实例
   - 添加全局锁机制防止并发创建
   - 所有实例共享同一个浏览器实例

3. **优化网络访问**：
   - 避免多个实例同时访问同一页面
   - 添加网络错误处理和回退机制
   - 智能跳过不必要的页面跳转

#### 技术实现
- **xiaohongshu-scraper.js**：添加全局浏览器实例管理和改进共享登录状态验证
- **全局实例管理**：使用静态属性管理全局浏览器实例
- **网络优化**：避免网络冲突和重复访问
- **测试脚本**：提供 `test-global-browser-instance.js` 验证修复效果

#### 优势
- ✅ 一次登录，长期使用
- ✅ 无需每次扫码登录
- ✅ Cookie和缓存自动持久化
- ✅ 提高用户体验和效率

### "未找到搜索栏"错误修复

#### 问题描述
在批量下载过程中，有时会出现"未找到搜索栏"的错误，导致搜索操作失败。

#### 根本原因
1. **浏览器实例被意外关闭**：在登录状态检测失败后，浏览器实例被意外关闭
2. **错误处理不完善**：当浏览器实例为null时，系统没有正确处理
3. **资源清理时机不当**：过早清理了浏览器资源
4. **缺乏重试机制**：没有在失败后自动重试

#### 修复方案
1. **改进浏览器实例检查**：在搜索操作前严格检查浏览器实例有效性
2. **增强错误处理**：提供更详细的错误信息和处理建议
3. **优化资源管理**：避免过早清理浏览器资源
4. **增加重试机制**：自动重试可恢复的错误，最多重试3次
5. **智能错误判断**：区分可重试和不可重试的错误类型

#### 技术实现
- **performSearch()方法增强**：增加浏览器实例验证和错误处理
- **autoReopenLoginPage()方法优化**：改进错误处理，避免过早清理资源
- **searchAndDownload()方法重试**：添加重试机制和智能错误判断
- **isRetryableError()方法**：判断错误是否可重试

### 优势
- ✅ 彻底解决日志重复问题
- ✅ 提高批量处理效率
- ✅ 减少用户登录次数
- ✅ 更好的用户体验
- ✅ 降低系统资源消耗
- ✅ **🆕 修复登录状态检测问题**：优化登录状态判断逻辑
- ✅ **🆕 解决新窗口登录同步问题**：确保登录状态正确同步
- ✅ **🆕 优化全局状态管理**：放宽限制，避免过度阻止登录
- ✅ **🆕 跨窗口登录状态检测**：自动检测新窗口登录状态变化
- ✅ **🆕 手动触发检测功能**：提供"检测登录状态"按钮
- ✅ **🆕 智能状态同步**：每10秒和30秒自动检测跨窗口登录

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置登录信息

```bash
cp config.template.json config.json
```

编辑 `config.json`，推荐配置：
```json
{
  "login": {
    "method": "manual",        // 手动登录
    "autoLogin": true,         // 启用自动登录
    "saveCookies": true,       // 保存Cookie
    "cookieFile": "./cookies.json"
  },
  "scraper": {
    "browserType": "chromium"  // 浏览器类型：chromium（默认）、user-browser
  }
}
```

### 3. 启动Web界面（推荐）

```bash
npm run start:web
```

启动后，系统会自动用Chromium浏览器打开：`http://localhost:3000`

**自动打开浏览器功能**：
- ✅ 服务启动后自动用Chromium浏览器打开Web界面
- ✅ 优先使用Playwright的Chromium浏览器
- ✅ 如果Chromium启动失败，自动回退到系统默认浏览器
- ✅ 延迟2秒打开，确保服务器完全启动
- ✅ 如果自动打开失败，不影响服务正常运行

### 4. 使用Web界面

1. **配置餐馆信息**：在左侧面板添加要下载的餐馆名称和地点
2. **设置输出目录**：选择图片保存的文件夹
3. **调整下载选项**：设置每个餐馆下载的图片数、是否去水印等
4. **开始下载**：点击"开始下载"按钮，实时查看进度和日志

### 5. 首次登录（Web界面）

**新的登录方式（推荐）：**

1. 启动Web界面后，在浏览器中访问 `http://localhost:3000`
2. 在左侧面板的"登录状态"区域，点击"登录小红书"按钮
3. 系统会弹出小红书登录窗口（模态框）
4. 在登录窗口中完成小红书登录（支持手机号验证码和扫码登录）
5. 登录完成后，点击"检查登录状态"按钮
6. 系统会自动检测并保存登录状态，登录窗口会自动关闭
7. 后续使用无需重复登录

**登录窗口特性：**
- 🖥️ 在同一个页面中完成登录，无需跳转
- 📱 支持手机号验证码登录和扫码登录
- 🔄 提供刷新页面功能
- ✅ 自动检测登录状态
- 🎨 美观的界面设计，响应式布局

### 6. 命令行模式（备选）

如果更喜欢命令行操作，也可以使用：

```bash
# 首次登录
npm run start:login

# 测试水印去除功能
npm run test:watermark

# 运行示例
node example-watermark-removal.js
```

## 使用方法

### Web界面使用（推荐）

#### 1. 启动Web界面

```bash
npm run start:web
```

#### 2. 配置餐馆信息

在Web界面左侧面板中：

- **添加餐馆**：点击"添加"按钮，输入餐馆名称和地点
- **批量导入**：支持JSON和CSV格式批量导入餐馆列表
- **编辑/删除**：可以随时编辑或删除已添加的餐馆

##### 批量导入格式说明

**JSON格式示例** (`example-restaurants.json`)：
```json
[
  {
    "name": "海底捞",
    "location": "北京朝阳区",
    "maxImages": 6
  },
  {
    "name": "星巴克", 
    "location": "上海徐汇区",
    "maxImages": 8
  }
]
```

**CSV格式示例** (`example-restaurants.csv`)：
```csv
海底捞,北京朝阳区,6
星巴克,上海徐汇区,8
麦当劳,深圳南山区,4

```

**注意事项**：
- CSV格式：`餐馆名称,地点,下载的图片数(可选)`
- 每行必须包含餐馆名称和地点，下载的图片数为可选（默认为6）
- 如果导入后"开始下载"按钮变灰，请检查导入文件格式是否正确

#### 3. 设置下载选项

- **输出目录**：选择图片保存的文件夹路径
- **每个餐馆下载的图片数**：设置每个餐馆下载的图片数量（默认6张）
- **智能去水印**：启用后自动去除小红书水印
- **图片后处理**：启用图片优化和裁剪
- **无头模式**：后台运行，不显示浏览器窗口

#### 4. 开始下载

点击"开始下载"按钮，系统会：

1. 自动打开浏览器进行登录（首次使用）
2. 按顺序处理每个餐馆
3. 实时显示下载进度和日志
4. 自动创建以餐馆名称命名的子文件夹保存图片

#### 5. 监控进度

- **进度条**：显示总体下载进度
- **当前任务**：显示正在处理的餐馆信息
- **统计信息**：显示完成数量、图片数量等
- **实时日志**：详细的处理日志，支持按级别过滤
- **终端日志**：所有服务器终端输出都会实时显示在前端，包括：
  - 服务器启动日志
  - 爬虫处理日志
  - 错误和警告信息
  - 调试信息
  - 系统状态更新

### 命令行使用（高级用户）

#### 1. 配置登录信息

```bash
cp config.template.json config.json
```

编辑 `config.json` 文件：

```json
{
  "login": {
    "method": "manual",        // 登录方式: "phone"(手机号), "qr"(扫码), "manual"(手动)
    "autoLogin": true,         // 是否启用自动登录
    "saveCookies": true,       // 是否保存Cookie
    "cookieFile": "./cookies.json"  // Cookie保存文件
  },
  "scraper": {
    "browserType": "chromium"  // 浏览器类型: "chromium"(默认), "user-browser"(用户当前浏览器)
  }
}
```

#### 2. 基本用法

```javascript
const { XiaohongshuScraper } = require('./src/xiaohongshu-scraper');

const scraper = new XiaohongshuScraper({
  downloadPath: './downloads', // 下载路径
  maxImages: 6, // 每个餐馆下载的图片数量
  headless: false, // 是否无头模式运行
  login: {
    method: 'manual', // 登录方式
    autoLogin: true, // 自动登录
    saveCookies: true // 保存Cookie
  }
});

// 搜索并下载餐馆图片
await scraper.searchAndDownload('海底捞', '北京朝阳区');
```

#### 3. 高级配置

```javascript
const scraper = new XiaohongshuScraper({
  downloadPath: './downloads',
  maxImages: 50,
  headless: true,
  delay: 2000, // 请求间隔（毫秒）
  timeout: 30000, // 页面加载超时时间
  tryRemoveWatermark: true, // 启用水印去除
  enableImageProcessing: true, // 启用图片后处理
  browserType: 'chromium' // 使用Chromium浏览器（默认）
});
```

## API 文档

### XiaohongshuScraper 类

#### 构造函数参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| downloadPath | string | './downloads' | 图片下载保存路径 |
| maxImages | number | 6 | 每个餐馆下载的图片数量 |
| headless | boolean | false | 是否无头模式运行 |
| delay | number | 1000 | 请求间隔时间（毫秒） |
| timeout | number | 30000 | 页面加载超时时间 |
| userAgent | string | 默认UA | 浏览器User-Agent |
| tryRemoveWatermark | boolean | true | 是否尝试去除水印 |
| enableImageProcessing | boolean | true | 是否启用图片后处理 |
| browserType | string | 'chromium' | 浏览器类型：'chromium'（默认）、'user-browser' |

#### 主要方法

##### searchAndDownload(restaurantName, location)

搜索并下载餐馆图片

**参数：**
- `restaurantName` (string): 餐馆名称
- `location` (string): 地点信息

**返回值：**
- `Promise<Object>`: 包含下载结果的对象

**示例：**
```javascript
const result = await scraper.searchAndDownload('星巴克', '上海徐汇区');
console.log(`成功下载 ${result.downloadedCount} 张图片`);
```

##### close()

关闭浏览器实例

**示例：**
```javascript
await scraper.close();
```

## 目录命名规则

### 📁 下载目录结构

程序会自动创建以餐馆名称命名的子文件夹来保存图片：

**目录命名规则：**
- 使用餐馆名称作为文件夹名称
- 自动清理文件名中的非法字符（如 `<>:"/\|?*` 等）
- 示例：`海底捞`、`星巴克`、`麦当劳`

**目录结构示例：**
```
downloads/
├── 海底捞/
│   ├── image_001.jpg
│   ├── image_002.jpg
│   └── ...
├── 星巴克/
│   ├── image_001.jpg
│   ├── image_002.jpg
│   └── ...
└── 麦当劳/
    ├── image_001.jpg
    ├── image_002.jpg
    └── ...
```

**注意事项：**
- 如果存在同名餐馆，后下载的会覆盖先下载的内容
- 建议在添加餐馆时确保名称的唯一性
- 文件夹名称会自动处理特殊字符，确保文件系统兼容性

## 水印去除功能说明

### 🚫 智能水印去除策略

程序采用智能裁剪技术来去除小红书图片中的水印：

#### 1. URL参数优化
- 移除水印相关参数（watermark、wm、mark、logo等）
- 移除尺寸限制参数（w、h、width、height等）
- 移除压缩和处理参数（compress、resize、crop等）
- 尝试获取原始图片URL

#### 2. 图片后处理技术
- **智能裁剪**：自动识别并裁剪右下角水印区域（15%宽度 × 10%高度）
- **高质量保存**：使用95%质量保存处理后的图片
- **自动清理**：只保存最终处理版本，自动删除原始图片和临时文件

#### 3. 配置选项

```javascript
const scraper = new XiaohongshuScraper({
    tryRemoveWatermark: true,        // 启用水印去除
    enableImageProcessing: true,     // 启用图片后处理
    // ... 其他配置
});
```

#### 4. 处理效果

- ✅ 自动识别右下角"小红书"水印
- ✅ 智能裁剪去除水印区域
- ✅ 保持图片质量的同时去除水印
- ✅ **只保存最终处理版本**，节省存储空间
- ✅ 自动清理临时文件，无需手动清理
- ✅ 详细的处理日志

## 登录方式说明

### 🍪 Cookie持久化方案（强烈推荐）

**一次登录，长期使用！**

- 配置 `"method": "manual"` 和 `"saveCookies": true`
- 首次运行时手动登录一次
- 登录状态自动保存到本地Cookie文件
- 后续运行自动使用Cookie，无需重复登录
- 只有在Cookie失效时才需要重新登录

**优势：**
- ✅ 无需每次输入验证码
- ✅ 无需每次扫码
- ✅ 自动化程度高
- ✅ 用户体验最佳

### 其他登录方式（备选）

### 1. 手机号验证码登录
- 配置 `"method": "phone"` 和您的手机号
- 程序会自动输入手机号并获取验证码
- 您需要在浏览器中输入收到的验证码
- **注意：每次运行都需要获取验证码，不够便捷**

### 2. 扫码登录
- 配置 `"method": "qr"`
- 程序会显示二维码，使用小红书APP扫描即可登录
- **注意：每次运行都需要扫码，不够便捷**

### 3. 手动登录
- 配置 `"method": "manual"`
- 程序会打开浏览器，您手动完成登录流程
- 推荐与Cookie持久化配合使用

## 注意事项

1. **合规使用**：请遵守小红书的服务条款，仅用于个人学习和研究目的
2. **频率控制**：建议设置适当的请求间隔，避免对服务器造成过大压力
3. **网络环境**：确保网络连接稳定，建议使用代理服务器
4. **存储空间**：确保有足够的磁盘空间存储下载的图片
5. **登录安全**：配置文件包含敏感信息，请妥善保管，不要提交到版本控制系统
6. **水印处理**：程序采用多种策略组合去除水印：
   - URL参数优化：移除水印相关参数，获取原图
   - 图片后处理：使用Sharp库进行裁剪、模糊、调整等处理
   - 智能识别：自动识别并处理右下角水印区域

## 故障排除

### 常见问题

#### 1. 登录成功但无法下载图片
**原因**：Cookie可能部分失效或搜索功能被反爬虫机制限制
**解决方案**：
- 运行 `node refresh-cookies.js` 重新获取有效Cookie
- 运行 `node improved-search-test.js` 使用改进的搜索策略
- 确保在浏览器中手动完成登录流程
- 检查搜索页面是否显示实际内容（不是只有版权信息）

#### 2. 自动Cookie刷新功能
**新功能**：系统现在具备智能Cookie刷新能力
**触发条件**：当检测到用户相关元素缺失时自动触发
**工作流程**：
1. 🔍 检测到用户相关元素缺失
2. 🔄 自动调用Cookie刷新机制
3. 🌐 使用当前浏览器实例进行刷新
4. 🔐 提示用户完成登录（如需要）
5. 💾 自动保存新的有效Cookie
6. ✅ 重新验证登录状态并继续搜索

**优势**：
- 无需手动干预，系统自动处理Cookie失效问题
- 使用现有浏览器实例，避免重复登录
- 智能检测，只在必要时触发刷新

#### 2. "开始下载"按钮变灰
**原因**：餐馆列表为空
**解决方案**：
- 检查是否已添加餐馆配置
- 如果使用批量导入，检查导入文件格式是否正确
- 查看实时日志中的错误信息
- 使用提供的示例文件测试导入功能

#### 2. 导入文件失败
**可能原因**：
- CSV文件格式不正确（缺少地点信息）
- JSON文件不是数组格式
- 文件编码问题

**解决方案**：
- 使用UTF-8编码保存文件
- 参考示例文件格式
- 确保每行数据完整（餐馆名称和地点）

#### 3. 登录失败
**解决方案**：
- 检查网络连接
- 确保Web界面正在运行（http://localhost:3000）
- 尝试重新点击"登录小红书"按钮
- 清除浏览器缓存和Cookie
- 检查防火墙设置是否阻止了本地连接

#### 4. 登录页面没有弹出
**解决方案**：
- 使用新的Web界面登录方式（推荐）
- 在Web界面中点击"登录小红书"按钮
- 系统会在新标签页中打开小红书登录页面
- 完成登录后点击"重新检查登录状态"按钮

#### 5. 用户数据目录冲突错误
**错误信息**：`Failed to create a ProcessSingleton for your profile directory`

**解决方案**：
```bash
# 清理浏览器数据目录
node clean-browser-data.js

# 或者手动删除
rm -rf browser-data

# 然后重新启动服务
npm run start:web
```

**原因**：多个Chromium实例同时使用同一个用户数据目录导致的冲突

#### 5. 终端日志停止但前端日志还在继续
**问题描述**：任务完成后，终端日志已经停止，但前端还在继续显示日志
**原因**：心跳检测定时器没有正确停止，继续发送日志到前端
**解决方案**：
- 系统已自动修复此问题，任务完成时会自动停止心跳检测
- 如果仍有问题，可以手动调用停止心跳检测API：
  ```bash
  curl -X POST http://localhost:3000/api/stop-heartbeat
  ```
- 或者重启Web服务器：
  ```bash
  # 停止服务器 (Ctrl+C)
  npm run start:web
  ```

## 错误处理

工具内置了完善的错误处理机制：

- 网络连接错误自动重试
- 页面加载超时处理
- 图片下载失败处理
- 详细的错误日志记录

## 更新日志

### v2.0.17 - 登录框重复弹出问题修复版本
- 🐛 **登录框重复弹出问题修复**
  - 修复用户扫码登录后，系统立即重新弹出登录框的问题
  - 增加登录冷却期机制，用户扫码登录后2分钟内不进行登录状态检测
  - 优化登录状态检测逻辑，在用户扫码后给更多时间让Cookie生效
  - 改进全局状态管理器，增加登录冷却期和更长的等待时间
- 🔧 **技术改进**
  - 在 `global-login-manager.js` 中添加登录冷却期机制
  - 在 `xiaohongshu-scraper.js` 中优化登录状态检测逻辑
  - 增加用户扫码后的等待时间，从30秒增加到60秒
  - 添加登录完成检测机制，每5秒检查一次登录状态
  - 防重复机制从10秒增加到2分钟，给用户更多时间完成扫码登录
- 📊 **修复效果**
  - 用户扫码登录后，系统不会立即重新弹出登录框
  - 给Cookie足够时间生效，避免误判登录状态
  - 提高用户体验，减少重复登录操作
  - 保持系统稳定性，避免频繁的登录状态检测

### v2.0.16 - Cookie持久化问题修复版本
- 🍪 **Cookie持久化问题修复**
  - 解决执行一批下载任务后，再次执行时仍需扫码验证的问题
  - 降低登录状态检测阈值从3到2，提高Cookie验证成功率
  - 改进Cookie验证逻辑，增加容错机制和回退策略
  - 优化浏览器实例复用机制，确保正确复用现有实例
- 🔧 **新增改进组件**
  - `improved-cookie-validator.js`：改进的Cookie验证器，支持多种验证策略
  - `improved-browser-manager.js`：改进的浏览器实例管理器，确保实例复用
  - `fix-cookie-persistence.js`：Cookie持久化问题修复脚本
- 📊 **验证机制优化**
  - 基础验证：检查Cookie格式和过期时间
  - 评分验证：计算登录评分，降低阈值提高成功率
  - 网络验证：实际访问页面验证（可选，带容错）
  - 备份机制：自动备份和恢复有效Cookie
- 🛠️ **技术改进**
  - 使用持久化浏览器上下文，确保Cookie和登录状态持久化
  - 智能Cookie管理，结合多种策略提高验证成功率
  - 增强错误处理和日志记录，提供详细的诊断信息
  - 支持Cookie备份和恢复，避免数据丢失

### v2.0.15 - 登录状态评分逻辑优化版本
- 🎯 **登录状态判断逻辑优化**
  - 降低重新登录阈值从0到2，避免"半登录"状态
  - 当评分在1-2之间时，现在也会触发自动重新打开登录页面
  - 优化防重复机制，从30秒减少到10秒，提高响应性
  - 改进登录窗口状态管理，添加状态验证方法
- 🔧 **异步操作错误处理增强**
  - 添加 `cleanupBrowserResources()` 方法，安全地清理浏览器资源
  - 增强错误处理，防止资源泄漏和内存问题
  - 添加更详细的错误类型判断和用户建议
  - 在登录失败时自动清理浏览器资源
- 📊 **前端状态同步机制**
  - 添加 `notifyFrontendLoginStatus()` 方法，实时通知前端登录状态变化
  - 当自动重新打开登录页面时，前端会收到详细的状态通知
  - 支持 'reopening'、'success'、'failed' 三种状态类型
  - 在 `web-interface.js` 和 `batch-processor.js` 中设置Web接口实例
- 🛠️ **技术改进**
  - 添加 `validateLoginWindowState()` 方法，验证登录窗口状态一致性
  - 添加 `setWebInterface()` 方法，支持前端状态同步
  - 改进资源清理机制，防止浏览器实例泄漏
  - 优化错误处理流程，提供更准确的错误诊断

### v2.0.14 - 登录窗口显示问题完全修复版本
- 🐛 **登录窗口显示问题完全解决**
  - 修复了前端使用 `window.open()` 导致登录窗口不可见的问题
  - 前端现在调用后端API (`/api/open-browser`) 来打开登录窗口
  - 后端API确保浏览器窗口强制显示，用户可以看到登录页面
  - 添加了详细的用户指导，包括窗口切换提示
- ✨ **智能登录窗口管理**
  - 防止重复打开登录窗口，智能检测现有窗口状态
  - 自动处理浏览器实例状态异常，确保窗口可见性
  - 提供多种窗口查找方法：Alt+Tab (Windows) 或 Cmd+Tab (Mac)
  - 支持浏览器实例状态验证和自动重建
- 🔧 **技术改进**
  - 前端 `openLoginModal()` 方法改为调用后端API
  - 后端 `handleOpenBrowser()` 方法确保浏览器窗口可见
  - 添加 `connectToUserBrowser()` 方法支持用户浏览器连接
  - 增强错误处理和用户反馈机制
- 📊 **用户体验优化**
  - 登录按钮状态实时更新，显示操作进度
  - 提供详细的窗口查找指导
  - 智能处理重复打开请求
  - 支持强制重置登录窗口状态

### v2.0.13 - 登录状态评分和界面优化版本
- 🎯 **登录状态评分系统**
  - 实现了基于Cookie数量和类型的登录状态评分机制
  - 当登录评分过低时，界面显示"登录状态评分过低"并显示登录按钮
  - 只有登录评分 > 0 时才能开始下载，确保登录状态有效
  - 开始下载按钮会根据登录状态自动启用/禁用，并显示相应提示
- 🔧 **界面逻辑优化**
  - 登录状态显示分为三种：已登录(评分正常)、登录状态评分过低、未登录
  - 不同状态显示不同的图标和提示信息，用户体验更清晰
  - 开始下载按钮会根据登录状态显示不同的提示文字
  - 添加了登录评分测试脚本，方便验证功能
- 📊 **状态检测增强**
  - 后端登录状态检查现在返回登录评分信息
  - 前端根据登录评分智能判断是否允许开始下载
  - 提供了详细的登录状态反馈，帮助用户了解当前状态

### v2.0.12 - 登录窗口显示问题完全修复版本
- ✅ **登录窗口显示问题完全解决**
  - 确认浏览器窗口能正常显示，用户可以看到小红书登录页面
  - 修复了无头模式导致的浏览器不可见问题
  - 添加了浏览器窗口最大化功能，确保窗口完全可见
  - 实现了登录按钮点击被弹窗遮罩阻止的问题修复
- 🎯 **用户体验优化**
  - 添加了详细的用户指导，提醒用户不要关闭浏览器窗口
  - 提供了窗口切换提示（Cmd+Tab），帮助用户找到浏览器窗口
  - 改进了登录流程的用户反馈，提供清晰的操作指导
  - 添加了JavaScript点击备选方案，解决弹窗遮罩问题
- 🔧 **技术改进**
  - 修复了 `batch-processor.js` 中的无头模式设置（从 `headless: true` 改为 `headless: false`）
  - 添加了浏览器窗口强制置前和最大化功能
  - 实现了登录按钮点击的多种策略（直接点击 + JavaScript点击）
  - 增强了浏览器启动参数，确保窗口可见性
- 📊 **测试验证**
  - 创建了专门的测试脚本验证浏览器窗口显示
  - 提供了完整的登录流程测试
  - 确认修复效果，用户可以看到浏览器窗口和登录页面

### v2.0.11 - 登录窗口状态管理修复版本
- 🐛 **登录窗口状态管理修复**
  - 修复了登录窗口状态混乱导致的死循环问题
  - 解决了"登录窗口已打开，请勿重复请求"但用户看不到窗口的问题
  - 添加了浏览器实例状态智能检测和自动重置功能
  - 修复了无头模式导致的浏览器不可见问题
- ✨ **智能状态检测和重置**
  - 添加了浏览器实例状态验证，自动检测浏览器是否真的在运行
  - 实现了登录窗口状态的智能重置，避免状态不一致
  - 支持强制显示浏览器窗口，确保用户能看到登录页面
  - 添加了重复打开请求的智能处理，避免重复创建窗口
- 🔧 **改进的浏览器管理**
  - 修复了 `batch-processor.js` 中的无头模式设置（从 `headless: true` 改为 `headless: false`）
  - 添加了浏览器窗口强制置前功能（`bringToFront()`）
  - 增强了浏览器启动参数，确保窗口可见性
  - 改进了浏览器实例的生命周期管理
- 📊 **增强的错误处理**
  - 添加了浏览器实例状态异常检测
  - 实现了登录窗口状态的自动恢复机制
  - 提供了更详细的调试信息和用户反馈
  - 支持浏览器崩溃后的自动重建

### v2.0.10 - 登录窗口显示问题修复版本
- 🐛 **登录窗口显示问题修复**
  - 修复了"重新打开登录页面没有看到"的问题
  - 添加了登录窗口状态重置功能，解决窗口状态不同步问题
  - 改进了弹窗被阻止的检测和处理逻辑
  - 增加了登录窗口打开状态的实时监控
- ✨ **新增重置登录状态功能**
  - 添加了 `/api/login/reset` API接口，支持重置登录窗口状态
  - 在前端界面添加了"重置登录状态"按钮
  - 支持强制关闭现有登录页面并重置状态
  - 提供用户友好的错误提示和解决方案
- 🔧 **改进的登录窗口管理**
  - 增强了登录窗口打开逻辑，添加弹窗阻止检测
  - 改进了登录按钮状态管理，防止重复操作
  - 添加了登录窗口状态的实时反馈
  - 优化了错误处理和用户提示信息
- 📊 **增强的用户体验**
  - 当登录窗口被阻止时，提供明确的解决方案
  - 添加了登录窗口状态的视觉反馈
  - 改进了错误提示的准确性和有用性
  - 支持一键重置登录状态，无需重启服务

### v2.0.9 - 自动登录优化版本
- 🐛 **自动重新登录失败修复**
  - 修复了自动重新打开登录页面失败导致无法共享Cookie的问题
  - 改进了登录界面的自动触发逻辑，确保二维码正确显示
  - 增强了Cookie保存的验证和错误处理
- ✨ **智能登录界面触发**
  - 新增 `triggerLoginInterface()` 方法，主动触发登录界面
  - 支持多种触发策略：点击登录按钮、访问用户页面、使用搜索功能
  - 改进了登录检测逻辑，支持多种登录完成检测方式
- 🔧 **详细调试信息**
  - 添加了详细的页面状态监控和调试输出
  - 增加了Cookie保存成功验证和统计信息
  - 提供具体的错误处理建议和解决方案
- 📊 **增强的页面状态检测**
  - 检测用户相关元素出现
  - 检测登录按钮和提示消失
  - 检测二维码显示状态
  - 每10秒输出一次详细状态信息
- 🛠️ **EPIPE错误修复**
  - 修复了日志转发机制中的EPIPE错误
  - 改进了Socket.IO连接状态检查
  - 添加了管道错误的静默处理机制
  - 增强了错误处理的健壮性

### v2.0.8 - 多登录窗口修复版本
- 🐛 **多登录窗口问题修复**
  - 修复前端登录按钮重复点击导致多个登录窗口的问题
  - 添加登录窗口状态检查，防止重复打开
  - 统一后端浏览器实例管理，避免重复创建浏览器
  - 优化心跳检测逻辑，减少不必要的日志输出
- 🔧 **防重复机制优化**
  - 前端登录按钮添加防重复点击机制
  - 后端浏览器实例统一管理，避免重复创建
  - 登录窗口状态全局管理，确保同时只有一个登录窗口
  - 心跳检测优化，减少日志刷屏问题
- 📊 **用户体验改进**
  - 登录按钮状态实时更新，显示登录进度
  - 登录窗口关闭时自动恢复按钮状态
  - 减少重复操作提示，提升用户体验
- 🔄 **智能登录状态管理**
  - 当登录状态评分 <= 0 时，自动重新打开小红书登录页面
  - 支持自动扫码登录，无需手动操作
  - 利用防重复机制，确保不会打开多个登录窗口
  - 登录完成后自动保存Cookie，实现一次登录长期使用

### v2.0.7 - Chromium浏览器自动打开版本
- 🌐 **Chromium浏览器自动打开功能**
  - 服务启动后自动用Chromium浏览器打开Web界面
  - 优先使用Playwright的Chromium浏览器
  - 如果Chromium启动失败，自动回退到系统默认浏览器
  - 延迟2秒打开，确保服务器完全启动
  - 添加autoOpenBrowser配置选项，默认为true
  - 完善的错误处理，打开失败不影响服务运行
- 🎯 **用户体验优化**
  - 无需手动打开浏览器访问地址
  - 自动使用Chromium浏览器，与爬虫功能保持一致
  - 提供详细的日志信息和回退机制

### v2.0.6 - 浏览器配置优化版本
- 🌐 **浏览器配置优化**
  - 明确配置默认使用Chromium浏览器
  - 在配置文件中添加browserType配置项
  - 支持两种浏览器类型：'chromium'（默认）、'user-browser'
  - 更新配置模板和文档，确保用户明确了解浏览器配置选项
- 📝 **文档更新**
  - 在README.md中添加浏览器类型配置说明
  - 更新API文档，添加browserType参数说明
  - 完善配置示例，包含浏览器类型配置

### v2.0.5 - 日志重复打印修复版本
- 🐛 **日志重复打印修复**
  - 修复前端日志重复打印四次的问题
  - 使用单例模式确保全局只有一个日志管理器实例
  - 避免多次初始化日志管理器导致的重复输出
  - 修复无限递归调用导致的内存溢出问题
- 🔧 **日志管理器优化**
  - 修改 `getLogger()` 函数使用单例模式
  - 避免重复重写 `console` 方法
  - 直接更新配置属性，避免递归调用
  - 确保日志只输出一次，不会重复

### v2.0.4 - 前端任务完成事件修复版本
- 🎯 **前端任务完成事件修复**
  - 修复前端没有监听任务完成事件的问题
  - 添加 `task_completed` 和 `task_final_completed` 事件监听
  - 添加 `heartbeat_stopped` 事件监听
  - 实现任务完成时自动停止前端心跳检测
- 🔧 **状态同步优化**
  - 任务完成时前端状态正确更新为已完成
  - 进度条显示100%完成状态
  - 餐馆进度状态正确更新
  - 统计信息实时同步
- 📊 **用户体验改进**
  - 任务完成后显示最终统计信息
  - 前端日志正确显示任务完成状态
  - 避免任务完成后前端仍在显示旧日志的问题
- 🛠️ **后端逻辑修复**
  - 修复 `web-interface.js` 中错误的事件监听逻辑
  - 修改 `batch-processor.js` 直接调用 `webInterface.stopHeartbeat()` 方法
  - 确保任务完成时正确停止心跳检测并发送事件到前端

### v2.0.3 - 心跳检测修复版本
- 🛑 **心跳检测修复**
  - 修复任务完成后心跳检测不停止的问题
  - 添加手动停止心跳检测的API接口 (`/api/stop-heartbeat`)
  - 改进资源清理机制，确保所有定时器都被正确清理
  - 添加心跳检测状态监控，实时显示定时器状态
- 🔧 **日志系统优化**
  - 任务完成时自动停止心跳检测
  - 添加心跳停止事件通知
  - 改进状态查询，包含心跳检测状态信息
- 🧪 **测试工具**
  - 添加心跳检测停止功能测试脚本
  - 提供手动测试和验证方法

### v2.0.2 - 终端日志转发版本
- 📝 **终端日志转发**
  - 所有终端输出都会实时转发到前端显示
  - 无需查看终端窗口，所有日志信息都在Web界面中显示
  - 支持服务器启动、爬虫处理、错误信息等所有类型的日志
  - 保持原有终端输出功能，同时发送到前端
- 🔧 **日志系统优化**
  - 创建统一的日志管理器，重写console方法
  - 支持多种日志级别（info、success、warning、error、debug）
  - 自动处理未捕获的异常和Promise拒绝
  - 提供详细的错误堆栈信息

### v2.0.1 - 界面优化版本
- 🎨 **界面简化**
  - 移除冗余的统计信息卡片，简化界面布局
  - 专注于核心功能，提升用户体验
  - 保持界面简洁，减少视觉干扰
- 🔧 **代码优化**
  - 清理无用的统计信息更新逻辑
  - 优化界面响应性能

### v2.0.0 - Web界面版本
- 🖥️ **全新Web图形界面**
  - 直观易用的浏览器界面，无需命令行操作
  - 实时进度显示和状态监控
  - 响应式设计，支持移动端访问
- 📊 **批量管理功能**
  - 支持添加、编辑、删除多个餐馆配置
  - 批量导入餐馆列表（JSON/CSV格式）
  - 配置保存和加载功能
- 🔄 **实时通信**
  - WebSocket实时状态更新
  - 详细的日志显示和过滤
  - 错误处理和用户反馈
- 🎯 **任务管理**
  - 支持暂停、恢复、停止下载任务
  - 并发控制，避免服务器压力过大
  - 智能错误恢复机制

### v1.2.0
- 🎯 **优化图片处理流程**
  - 只保存最终处理版本，节省存储空间
  - 自动删除原始图片和临时文件
  - 简化处理逻辑，提高效率
- 🚫 **改进水印去除功能**
  - 专注于智能裁剪技术
  - 使用95%高质量保存
  - 自动清理，无需手动操作
- 📁 **存储优化**
  - 每个图片只保存一个最终版本
  - 自动清理临时文件
  - 减少磁盘空间占用

### v1.2.1
- 📊 **服务状态日志增强**
  - 添加服务运行状态日志，让用户清楚了解服务状态
  - 实现服务心跳检测，每30秒检测一次服务状态
  - 添加任务状态变化日志（开始、暂停、恢复、完成）
  - 增加服务连接状态日志（连接、断开、错误）
  - 优化日志显示，避免重复日志刷屏

### v1.2.0
- 🎨 **界面优化**
  - 重新设计下载进度界面，使用更紧凑的布局
  - 优化餐馆进度显示，一行显示所有信息
  - 添加进度摘要显示（完成数量统计）
  - 改进当前任务信息的显示方式
  - 提升整体界面的美观性和实用性

### v1.1.0
- 🚫 **新增智能水印去除功能**
  - 多种URL参数优化策略
  - 图片后处理技术（裁剪、模糊、调整）
  - 智能识别右下角水印区域
- 🖼️ **新增图片处理功能**
  - 集成Sharp库进行图片优化
  - 支持多种图片格式处理
  - 自动清理临时文件
- ⚙️ **配置优化**
  - 新增tryRemoveWatermark配置项
  - 新增enableImageProcessing配置项
  - 改进错误处理机制

### v1.0.0
- 初始版本发布
- 实现基本的搜索和下载功能
- 添加错误处理和日志记录

## 🔧 最新修复 (2024-09-26)

### 界面布局优化 - 登录状态板块位置调整

**问题**：用户反馈"登录状态"板块位置不够突出，希望将其放在界面最上面
- ❌ 登录状态板块位于配置区域下方，不够显眼
- ❌ 用户需要先查看登录状态，再配置其他选项
- ❌ 界面布局不够直观，登录状态不够突出

**解决方案**：将登录状态板块移动到界面最顶部
- ✅ **位置优化**：将"登录状态"板块移动到界面最顶部，位于所有配置区域之前
- ✅ **用户流程优化**：用户一打开页面就能看到登录状态，更符合使用习惯
- ✅ **界面层次清晰**：登录状态 -> 配置区域 -> 下载进度，逻辑更清晰
- ✅ **保持功能完整**：所有登录相关功能保持不变，只是位置调整
- ✅ **响应式优化**：移动端布局自动调整，确保最佳显示效果

**技术实现**：
- 将"登录状态"板块从#contentSection移动到#configSection之前
- 保持原有的HTML结构和功能不变
- 更新CSS样式选择器，适配新的位置
- 优化响应式设计，确保移动端正常显示
- 调整界面层次，让登录状态更加突出

### 界面布局优化 - 开始下载按钮位置调整

**问题**：用户反馈"开始下载"按钮位置不够合理，希望将其放在"餐馆配置"区域中
- ❌ "开始下载"按钮位于独立的"控制按钮"卡片中，与餐馆配置分离
- ❌ 用户需要先配置餐馆，再单独点击开始下载，操作不够连贯
- ❌ 界面布局分散，功能关联性不强

**解决方案**：将开始下载按钮移动到餐馆配置卡片中
- ✅ **按钮位置优化**：将"开始下载"按钮移动到"餐馆配置"卡片头部
- ✅ **操作流程优化**：配置餐馆和开始下载在同一区域，操作更连贯
- ✅ **按钮顺序调整**：开始下载 -> 添加 -> 导入，符合用户操作习惯
- ✅ **界面简化**：删除独立的"控制按钮"卡片，登录状态板块占满整行
- ✅ **保持功能完整**：所有按钮功能保持不变，只是位置调整

**技术实现**：
- 将"开始下载"按钮从"控制按钮"卡片移动到"餐馆配置"卡片头部
- 调整按钮顺序：开始下载在添加按钮的左边
- 删除独立的"控制按钮"卡片，简化界面布局
- 登录状态板块调整为占满整行显示
- 更新CSS样式，为餐馆配置中的开始下载按钮添加适当样式
- 优化响应式设计，确保移动端正常显示

### 界面布局优化 - 删除系统信息板块

**问题**：用户反馈"系统信息"板块占用空间，希望删除以简化界面
- ❌ 系统信息板块占用宝贵的界面空间
- ❌ 用户更关注配置和操作功能，系统信息不是必需的
- ❌ 界面布局可以更加简洁

**解决方案**：删除系统信息板块，优化布局
- ✅ **删除系统信息板块**：完全移除系统信息卡片，释放界面空间
- ✅ **布局重新平衡**：配置设置和餐馆配置各占50%空间（col-lg-6）
- ✅ **界面更简洁**：专注于核心功能，减少不必要的展示信息
- ✅ **保持功能完整**：所有配置和操作功能保持不变
- ✅ **响应式优化**：移动端布局自动调整，确保最佳显示效果

**技术实现**：
- 删除HTML中的"系统信息"卡片（col-lg-3）
- 将"配置设置"从col-lg-4调整为col-lg-6
- 将"餐馆配置"从col-lg-5调整为col-lg-6
- 更新CSS样式选择器，适配新的布局结构
- 移除系统信息相关的CSS样式
- 优化响应式设计，确保移动端正常显示

### 界面布局优化 - 配置管理按钮位置调整

**问题**：用户反馈"保存配置"和"加载配置"按钮位置不够合理，希望将其放在"配置设置"区域中
- ❌ 配置管理按钮位于独立的卡片中，与配置设置分离
- ❌ 用户需要先配置参数，再单独保存配置，操作不够连贯
- ❌ 界面布局不够直观，功能分散

**解决方案**：重新设计配置区域布局
- ✅ **配置按钮整合**：将"保存配置"和"加载配置"按钮移动到"配置设置"卡片中
- ✅ **操作流程优化**：配置参数和保存配置在同一区域，操作更连贯
- ✅ **系统信息展示**：将原来的"配置管理"卡片改为"系统信息"卡片，展示工具版本和功能特性
- ✅ **保持主题色彩**：配置设置使用蓝色主题，系统信息也使用蓝色主题保持一致性
- ✅ **响应式设计**：在移动端自动调整布局，确保按钮在小屏幕上也能正常使用

**技术实现**：
- 在"配置设置"卡片中添加配置管理按钮区域
- 将原来的"配置管理"卡片改为"系统信息"卡片，展示工具信息
- 更新CSS样式，为配置设置中的按钮添加蓝色主题样式
- 保持原有的按钮功能和交互逻辑不变
- 优化移动端显示效果

### 界面布局优化 - 登录状态板块位置调整

**问题**：用户反馈登录状态板块位置不够突出，希望将其放在下载进度板块上方
- ❌ 登录状态板块位于左侧，不够显眼
- ❌ 用户需要先查看登录状态，再查看下载进度
- ❌ 界面布局不够直观

**解决方案**：重新设计界面布局
- ✅ **登录状态板块上移**：将登录状态板块移至下载进度板块上方
- ✅ **全宽显示**：登录状态板块使用全宽显示，更加突出
- ✅ **左右分栏布局**：登录状态和控制按钮并排显示，充分利用空间
- ✅ **响应式设计**：在移动端自动调整为垂直布局
- ✅ **保持主题色彩**：登录状态使用橙色主题，控制按钮使用绿色主题

**技术实现**：
- 将登录状态板块从 `col-lg-4` 改为 `col-lg-12`，占满整行
- 登录状态和控制按钮使用 `col-lg-6` 并排显示
- 下载进度板块紧随其后，保持原有功能
- 更新CSS选择器，适配新的DOM结构
- 添加移动端响应式样式

### CSV导入数据清理修复

**问题**：CSV导入时无法正确处理包含特殊字符和跨行数据的餐馆名称
- ❌ "韩清洞韩式酱蟹炭火烤肉(甜水园店)"等包含括号的餐馆名称无法导入
- ❌ 数据中包含回车符、制表符等不可见字符导致解析失败
- ❌ 跨行数据被错误分割，导致解析失败
- ❌ 只处理`\n`换行符，未处理`\r\n`等其他格式
- ❌ 字符串清理不彻底，只清理首尾空白

**解决方案**：全面改进CSV解析和数据清理
- ✅ **多换行符支持**：使用正则表达式`/\r?\n|\r/`处理所有换行符格式
- ✅ **跨行数据合并**：智能检测和合并跨行的CSV数据
- ✅ **彻底字符清理**：使用`/[\r\n\t\s]+/g`清理所有类型的空白字符
- ✅ **改进引号处理**：正确处理CSV中的引号包围字段
- ✅ **详细调试信息**：显示每行解析过程和清理结果
- ✅ **数据验证增强**：验证清理后的数据完整性

### Cookie登录验证修复

**问题**：Cookie验证逻辑存在严重缺陷
- ❌ 跳过页面登录状态检查，误判登录成功
- ❌ 阈值过低（Cookie评分>=2就认为登录成功）
- ❌ 实际页面显示登录弹窗，但系统认为已登录
- ❌ 用户看到"Cookie登录成功"，但界面要求重新登录

**解决方案**：严格验证登录状态
- ✅ **真正检查页面状态**：检测登录弹窗、登录提示、登录按钮
- ✅ **提高验证标准**：Cookie评分阈值从2提升到5
- ✅ **双重验证**：必须同时满足Cookie评分高 AND 页面无登录提示
- ✅ **强制重新登录**：如果检测到登录弹窗，立即重新登录
- ✅ **详细日志**：显示页面登录状态检查结果，便于调试

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request来改进这个工具。

---

**免责声明**：本工具仅供学习和研究使用，请遵守相关法律法规和网站服务条款。
