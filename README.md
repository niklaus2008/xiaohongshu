# 小红书餐馆图片下载工具

## 项目简介

这是一个基于Playwright的自动化工具，可以根据餐馆名称和地点信息，从小红书上搜索并下载对应餐馆的图片。现在支持**Web图形界面**，让您可以通过直观的界面轻松管理批量下载任务。

## 功能特点

### 🖥️ Web图形界面
- **直观易用的Web界面**：无需命令行操作，通过浏览器即可完成所有配置
- **实时进度显示**：可视化进度条和状态信息，清晰了解下载进度
- **批量配置管理**：支持添加、编辑、删除多个餐馆配置
- **配置保存/加载**：自动保存配置，下次使用时无需重新设置
- **实时日志显示**：详细的日志信息，支持按级别过滤
- **响应式设计**：适配不同屏幕尺寸，支持移动端访问
- **简洁界面**：移除冗余的统计信息，专注于核心功能
- **紧凑进度显示**：优化下载进度界面，使用更紧凑的布局显示餐馆进度

### 🔍 核心功能
- 根据餐馆名称和地点智能搜索
- 自动下载餐馆相关图片
- 支持批量下载
- 自动创建以餐馆名称命名的文件夹管理图片
- 内置反爬虫检测处理
- 详细的日志记录
- 多种登录方式支持（手机号验证码、扫码登录、手动登录）
- Cookie持久化，避免重复登录
- **智能水印去除**：多种策略组合去除小红书水印
- **图片后处理**：使用Sharp库进行图片优化和水印处理

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置登录信息

```bash
cp config.template.json config.json
```

编辑 `config.json`，推荐配置：
```json
{
  "login": {
    "method": "manual",        // 手动登录
    "autoLogin": true,         // 启用自动登录
    "saveCookies": true,       // 保存Cookie
    "cookieFile": "./cookies.json"
  }
}
```

### 3. 启动Web界面（推荐）

```bash
npm run start:web
```

启动后，在浏览器中访问：`http://localhost:3000`

### 4. 使用Web界面

1. **配置餐馆信息**：在左侧面板添加要下载的餐馆名称和地点
2. **设置输出目录**：选择图片保存的文件夹
3. **调整下载选项**：设置每个餐馆下载的图片数、是否去水印等
4. **开始下载**：点击"开始下载"按钮，实时查看进度和日志

### 5. 首次登录（Web界面）

**新的登录方式（推荐）：**

1. 启动Web界面后，在浏览器中访问 `http://localhost:3000`
2. 在左侧面板的"登录状态"区域，点击"登录小红书"按钮
3. 系统会弹出小红书登录窗口（模态框）
4. 在登录窗口中完成小红书登录（支持手机号验证码和扫码登录）
5. 登录完成后，点击"检查登录状态"按钮
6. 系统会自动检测并保存登录状态，登录窗口会自动关闭
7. 后续使用无需重复登录

**登录窗口特性：**
- 🖥️ 在同一个页面中完成登录，无需跳转
- 📱 支持手机号验证码登录和扫码登录
- 🔄 提供刷新页面功能
- ✅ 自动检测登录状态
- 🎨 美观的界面设计，响应式布局

### 6. 命令行模式（备选）

如果更喜欢命令行操作，也可以使用：

```bash
# 首次登录
npm run start:login

# 测试水印去除功能
npm run test:watermark

# 运行示例
node example-watermark-removal.js
```

## 使用方法

### Web界面使用（推荐）

#### 1. 启动Web界面

```bash
npm run start:web
```

#### 2. 配置餐馆信息

在Web界面左侧面板中：

- **添加餐馆**：点击"添加"按钮，输入餐馆名称和地点
- **批量导入**：支持JSON和CSV格式批量导入餐馆列表
- **编辑/删除**：可以随时编辑或删除已添加的餐馆

##### 批量导入格式说明

**JSON格式示例** (`example-restaurants.json`)：
```json
[
  {
    "name": "海底捞",
    "location": "北京朝阳区",
    "maxImages": 6
  },
  {
    "name": "星巴克", 
    "location": "上海徐汇区",
    "maxImages": 8
  }
]
```

**CSV格式示例** (`example-restaurants.csv`)：
```csv
海底捞,北京朝阳区,6
星巴克,上海徐汇区,8
麦当劳,深圳南山区,4

```

**注意事项**：
- CSV格式：`餐馆名称,地点,下载的图片数(可选)`
- 每行必须包含餐馆名称和地点，下载的图片数为可选（默认为6）
- 如果导入后"开始下载"按钮变灰，请检查导入文件格式是否正确

#### 3. 设置下载选项

- **输出目录**：选择图片保存的文件夹路径
- **每个餐馆下载的图片数**：设置每个餐馆下载的图片数量（默认6张）
- **智能去水印**：启用后自动去除小红书水印
- **图片后处理**：启用图片优化和裁剪
- **无头模式**：后台运行，不显示浏览器窗口

#### 4. 开始下载

点击"开始下载"按钮，系统会：

1. 自动打开浏览器进行登录（首次使用）
2. 按顺序处理每个餐馆
3. 实时显示下载进度和日志
4. 自动创建以餐馆名称命名的子文件夹保存图片

#### 5. 监控进度

- **进度条**：显示总体下载进度
- **当前任务**：显示正在处理的餐馆信息
- **统计信息**：显示完成数量、图片数量等
- **实时日志**：详细的处理日志，支持按级别过滤

### 命令行使用（高级用户）

#### 1. 配置登录信息

```bash
cp config.template.json config.json
```

编辑 `config.json` 文件：

```json
{
  "login": {
    "method": "manual",        // 登录方式: "phone"(手机号), "qr"(扫码), "manual"(手动)
    "autoLogin": true,         // 是否启用自动登录
    "saveCookies": true,       // 是否保存Cookie
    "cookieFile": "./cookies.json"  // Cookie保存文件
  }
}
```

#### 2. 基本用法

```javascript
const { XiaohongshuScraper } = require('./src/xiaohongshu-scraper');

const scraper = new XiaohongshuScraper({
  downloadPath: './downloads', // 下载路径
  maxImages: 6, // 每个餐馆下载的图片数量
  headless: false, // 是否无头模式运行
  login: {
    method: 'manual', // 登录方式
    autoLogin: true, // 自动登录
    saveCookies: true // 保存Cookie
  }
});

// 搜索并下载餐馆图片
await scraper.searchAndDownload('海底捞', '北京朝阳区');
```

#### 3. 高级配置

```javascript
const scraper = new XiaohongshuScraper({
  downloadPath: './downloads',
  maxImages: 50,
  headless: true,
  delay: 2000, // 请求间隔（毫秒）
  timeout: 30000, // 页面加载超时时间
  tryRemoveWatermark: true, // 启用水印去除
  enableImageProcessing: true // 启用图片后处理
});
```

## API 文档

### XiaohongshuScraper 类

#### 构造函数参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| downloadPath | string | './downloads' | 图片下载保存路径 |
| maxImages | number | 6 | 每个餐馆下载的图片数量 |
| headless | boolean | false | 是否无头模式运行 |
| delay | number | 1000 | 请求间隔时间（毫秒） |
| timeout | number | 30000 | 页面加载超时时间 |
| userAgent | string | 默认UA | 浏览器User-Agent |
| tryRemoveWatermark | boolean | true | 是否尝试去除水印 |
| enableImageProcessing | boolean | true | 是否启用图片后处理 |

#### 主要方法

##### searchAndDownload(restaurantName, location)

搜索并下载餐馆图片

**参数：**
- `restaurantName` (string): 餐馆名称
- `location` (string): 地点信息

**返回值：**
- `Promise<Object>`: 包含下载结果的对象

**示例：**
```javascript
const result = await scraper.searchAndDownload('星巴克', '上海徐汇区');
console.log(`成功下载 ${result.downloadedCount} 张图片`);
```

##### close()

关闭浏览器实例

**示例：**
```javascript
await scraper.close();
```

## 目录命名规则

### 📁 下载目录结构

程序会自动创建以餐馆名称命名的子文件夹来保存图片：

**目录命名规则：**
- 使用餐馆名称作为文件夹名称
- 自动清理文件名中的非法字符（如 `<>:"/\|?*` 等）
- 示例：`海底捞`、`星巴克`、`麦当劳`

**目录结构示例：**
```
downloads/
├── 海底捞/
│   ├── image_001.jpg
│   ├── image_002.jpg
│   └── ...
├── 星巴克/
│   ├── image_001.jpg
│   ├── image_002.jpg
│   └── ...
└── 麦当劳/
    ├── image_001.jpg
    ├── image_002.jpg
    └── ...
```

**注意事项：**
- 如果存在同名餐馆，后下载的会覆盖先下载的内容
- 建议在添加餐馆时确保名称的唯一性
- 文件夹名称会自动处理特殊字符，确保文件系统兼容性

## 水印去除功能说明

### 🚫 智能水印去除策略

程序采用智能裁剪技术来去除小红书图片中的水印：

#### 1. URL参数优化
- 移除水印相关参数（watermark、wm、mark、logo等）
- 移除尺寸限制参数（w、h、width、height等）
- 移除压缩和处理参数（compress、resize、crop等）
- 尝试获取原始图片URL

#### 2. 图片后处理技术
- **智能裁剪**：自动识别并裁剪右下角水印区域（15%宽度 × 10%高度）
- **高质量保存**：使用95%质量保存处理后的图片
- **自动清理**：只保存最终处理版本，自动删除原始图片和临时文件

#### 3. 配置选项

```javascript
const scraper = new XiaohongshuScraper({
    tryRemoveWatermark: true,        // 启用水印去除
    enableImageProcessing: true,     // 启用图片后处理
    // ... 其他配置
});
```

#### 4. 处理效果

- ✅ 自动识别右下角"小红书"水印
- ✅ 智能裁剪去除水印区域
- ✅ 保持图片质量的同时去除水印
- ✅ **只保存最终处理版本**，节省存储空间
- ✅ 自动清理临时文件，无需手动清理
- ✅ 详细的处理日志

## 登录方式说明

### 🍪 Cookie持久化方案（强烈推荐）

**一次登录，长期使用！**

- 配置 `"method": "manual"` 和 `"saveCookies": true`
- 首次运行时手动登录一次
- 登录状态自动保存到本地Cookie文件
- 后续运行自动使用Cookie，无需重复登录
- 只有在Cookie失效时才需要重新登录

**优势：**
- ✅ 无需每次输入验证码
- ✅ 无需每次扫码
- ✅ 自动化程度高
- ✅ 用户体验最佳

### 其他登录方式（备选）

### 1. 手机号验证码登录
- 配置 `"method": "phone"` 和您的手机号
- 程序会自动输入手机号并获取验证码
- 您需要在浏览器中输入收到的验证码
- **注意：每次运行都需要获取验证码，不够便捷**

### 2. 扫码登录
- 配置 `"method": "qr"`
- 程序会显示二维码，使用小红书APP扫描即可登录
- **注意：每次运行都需要扫码，不够便捷**

### 3. 手动登录
- 配置 `"method": "manual"`
- 程序会打开浏览器，您手动完成登录流程
- 推荐与Cookie持久化配合使用

## 注意事项

1. **合规使用**：请遵守小红书的服务条款，仅用于个人学习和研究目的
2. **频率控制**：建议设置适当的请求间隔，避免对服务器造成过大压力
3. **网络环境**：确保网络连接稳定，建议使用代理服务器
4. **存储空间**：确保有足够的磁盘空间存储下载的图片
5. **登录安全**：配置文件包含敏感信息，请妥善保管，不要提交到版本控制系统
6. **水印处理**：程序采用多种策略组合去除水印：
   - URL参数优化：移除水印相关参数，获取原图
   - 图片后处理：使用Sharp库进行裁剪、模糊、调整等处理
   - 智能识别：自动识别并处理右下角水印区域

## 故障排除

### 常见问题

#### 1. 登录成功但无法下载图片
**原因**：Cookie可能部分失效或搜索功能被反爬虫机制限制
**解决方案**：
- 运行 `node refresh-cookies.js` 重新获取有效Cookie
- 运行 `node improved-search-test.js` 使用改进的搜索策略
- 确保在浏览器中手动完成登录流程
- 检查搜索页面是否显示实际内容（不是只有版权信息）

#### 2. 自动Cookie刷新功能
**新功能**：系统现在具备智能Cookie刷新能力
**触发条件**：当检测到用户相关元素缺失时自动触发
**工作流程**：
1. 🔍 检测到用户相关元素缺失
2. 🔄 自动调用Cookie刷新机制
3. 🌐 使用当前浏览器实例进行刷新
4. 🔐 提示用户完成登录（如需要）
5. 💾 自动保存新的有效Cookie
6. ✅ 重新验证登录状态并继续搜索

**优势**：
- 无需手动干预，系统自动处理Cookie失效问题
- 使用现有浏览器实例，避免重复登录
- 智能检测，只在必要时触发刷新

#### 2. "开始下载"按钮变灰
**原因**：餐馆列表为空
**解决方案**：
- 检查是否已添加餐馆配置
- 如果使用批量导入，检查导入文件格式是否正确
- 查看实时日志中的错误信息
- 使用提供的示例文件测试导入功能

#### 2. 导入文件失败
**可能原因**：
- CSV文件格式不正确（缺少地点信息）
- JSON文件不是数组格式
- 文件编码问题

**解决方案**：
- 使用UTF-8编码保存文件
- 参考示例文件格式
- 确保每行数据完整（餐馆名称和地点）

#### 3. 登录失败
**解决方案**：
- 检查网络连接
- 确保Web界面正在运行（http://localhost:3000）
- 尝试重新点击"登录小红书"按钮
- 清除浏览器缓存和Cookie
- 检查防火墙设置是否阻止了本地连接

#### 4. 登录页面没有弹出
**解决方案**：
- 使用新的Web界面登录方式（推荐）
- 在Web界面中点击"登录小红书"按钮
- 系统会在新标签页中打开小红书登录页面
- 完成登录后点击"重新检查登录状态"按钮

## 错误处理

工具内置了完善的错误处理机制：

- 网络连接错误自动重试
- 页面加载超时处理
- 图片下载失败处理
- 详细的错误日志记录

## 更新日志

### v2.0.1 - 界面优化版本
- 🎨 **界面简化**
  - 移除冗余的统计信息卡片，简化界面布局
  - 专注于核心功能，提升用户体验
  - 保持界面简洁，减少视觉干扰
- 🔧 **代码优化**
  - 清理无用的统计信息更新逻辑
  - 优化界面响应性能

### v2.0.0 - Web界面版本
- 🖥️ **全新Web图形界面**
  - 直观易用的浏览器界面，无需命令行操作
  - 实时进度显示和状态监控
  - 响应式设计，支持移动端访问
- 📊 **批量管理功能**
  - 支持添加、编辑、删除多个餐馆配置
  - 批量导入餐馆列表（JSON/CSV格式）
  - 配置保存和加载功能
- 🔄 **实时通信**
  - WebSocket实时状态更新
  - 详细的日志显示和过滤
  - 错误处理和用户反馈
- 🎯 **任务管理**
  - 支持暂停、恢复、停止下载任务
  - 并发控制，避免服务器压力过大
  - 智能错误恢复机制

### v1.2.0
- 🎯 **优化图片处理流程**
  - 只保存最终处理版本，节省存储空间
  - 自动删除原始图片和临时文件
  - 简化处理逻辑，提高效率
- 🚫 **改进水印去除功能**
  - 专注于智能裁剪技术
  - 使用95%高质量保存
  - 自动清理，无需手动操作
- 📁 **存储优化**
  - 每个图片只保存一个最终版本
  - 自动清理临时文件
  - 减少磁盘空间占用

### v1.2.1
- 📊 **服务状态日志增强**
  - 添加服务运行状态日志，让用户清楚了解服务状态
  - 实现服务心跳检测，每30秒检测一次服务状态
  - 添加任务状态变化日志（开始、暂停、恢复、完成）
  - 增加服务连接状态日志（连接、断开、错误）
  - 优化日志显示，避免重复日志刷屏

### v1.2.0
- 🎨 **界面优化**
  - 重新设计下载进度界面，使用更紧凑的布局
  - 优化餐馆进度显示，一行显示所有信息
  - 添加进度摘要显示（完成数量统计）
  - 改进当前任务信息的显示方式
  - 提升整体界面的美观性和实用性

### v1.1.0
- 🚫 **新增智能水印去除功能**
  - 多种URL参数优化策略
  - 图片后处理技术（裁剪、模糊、调整）
  - 智能识别右下角水印区域
- 🖼️ **新增图片处理功能**
  - 集成Sharp库进行图片优化
  - 支持多种图片格式处理
  - 自动清理临时文件
- ⚙️ **配置优化**
  - 新增tryRemoveWatermark配置项
  - 新增enableImageProcessing配置项
  - 改进错误处理机制

### v1.0.0
- 初始版本发布
- 实现基本的搜索和下载功能
- 添加错误处理和日志记录

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request来改进这个工具。

---

**免责声明**：本工具仅供学习和研究使用，请遵守相关法律法规和网站服务条款。
